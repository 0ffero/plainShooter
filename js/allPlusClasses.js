const consts={appName:"plainShooter",canvas:{colour:"#111111",width:1280,height:720,cX:640,cY:360},depths:{background:1,clouds:5,fgMask:7,nightMask:10,stars:15,game:20,bullets:25,enemies:30,player:35,fog:40,pickups:50,gameUI:55,alienUI:60,fg:70,playerIntroText:90,mainUI:100,intro:666},scoreMult:5};function angleReflect(e,t){let a=2*t-e;return a>=360?a-360:a<0?a+360:a}String.prototype.capitalise=function(){return this.charAt(0).toUpperCase()+this.slice(1)},angleRealToPhaser=(e=0)=>"number"==typeof e&&(e<=270?e-90:e-450);var checkType=(e,t)=>{let a=!1;switch(t){case"array":a=!!Array.isArray(e);break;case"boolean":case"bool":a="boolean"==typeof e;break;case"float":a=!Number.isInteger(e)&&"number"==typeof e;break;case"integer":case"int":a=!!Number.isInteger(e);break;case"number":a="number"==typeof e;break;case"object":a="object"==typeof e;break;case"string":case"str":a="string"==typeof e;break;default:console.error(`This type (${t}) has no check!
Unable to test variables validity.`),a=!1}return a};function framesToMs(e){return!!Number.isInteger(e)&&1e3/60*e}function generateRandomID(e=!1){generatedID="";let t=8;!1!==e&&(t=16);for(let a=0;a<t;a++)generatedID+=~~(9*Math.random()+1).toString();return generatedID}function isVar(e="Phaser"){let t="";for(var a in"Phaser"===e&&(t="No variable passed... Searching for Phaser variable\n"),window)if(window.hasOwnProperty(a)&&a===e)return t+=`Found the variable '${e}'`,vars.DEBUG&&console.log(t),!0;return!1}function shuffle(e){for(var t,a,s=e.length;0!==s;)a=Math.floor(Math.random()*s),s-=1,t=e[s],e[s]=e[a],e[a]=t;return e}function getRandom(e,t=null){return Phaser?Array.isArray(e)?Phaser.Math.RND.pick(e):"number"==typeof e&&"number"==typeof t?Phaser.Math.RND.between(e,t):"string"==typeof e&&null===t?Phaser.Math.RND.pick(e.split("")):void console.error("The first passed var must either be an array, integer or string. If a 2nd value is passed it must be an integer"):(console.error("This function needs Phaser to be initialised before use!"),!1)}"use strict";var vars={DEBUG:!1,version:.5,versions:[["0.1",'            Parallax bg added (main reason for this demo)            Plane has been added. Can take damage. Can also heal. Player intro added            Player can move and shoot using cursors/space. Player 1 can also use WASD + Mouse, if theres no 2nd player (which there isnt just now)            Audio for planes engine and shooting added            Intro text added.            Enemies added. They introduce themselves in the background (using low saturation shader), then spawn at the right side of the screen in formation.            Enemy planes "bob" up and down slightly instead of staying at a specific y position, coz it was boring the old way            '],["0.13","            Enemies are now generated at the start of the game. They can also be shot down. Points are given to the player based on hits,kills and groupkills.            Added night time mask. Every 5000m it will change from day to night and nice versa            Player can now take damage and die            "],["0.14->0.5","            Added end of level actions system to change day/night/fog etc on command(0.14)            Weather Added (0.15)            The 2nd half of the game (space sim) including all animations are done. (0.2)            Aliens are implemented, including sound, animations etc (0.2)            The alien boss can now spawn, fire ummm fire and eyes at you, and die. (0.3)            The game is now completable. (0.4)            Music tracks have been added, however, theyve not been vetted for each of their current uses, so expect changes to intro, earth, space and boss music. (0.5)            Added foo fighters although they havent been added to the break reality section of space sim yet.            Players rockets have been added to the player atlas but still needs implementing"]],bugs:["When player dies, destroy all pickups that are on screen","Players force isnt taking effect on death"],init(e){switch(e){case"PRELOAD":vars.files.loadAssets(),vars.localStorage.init();break;case"CREATE":vars.audio.init(),vars.input.init(),vars.physics.init();break;case"STARTAPP":vars.UI.init(),vars.camera.init();break;default:return console.error(`Phase (${e}) was invalid!`),!1}},files:{audio:{load(e){let t="audio";[["plane_engine",`${t}/engine.ogg`],["plane_engine_space",`${t}/engine_space.ogg`],["plane_explode",`${t}/explosion.ogg`],["plane_shoot",`${t}/shoot.ogg`],["pickup",`${t}/pickup.ogg`],["ricochet",`${t}/ricochet.ogg`],["static",`${t}/static.ogg`],["breathe_fire",`${t}/breathe_fire.ogg`],["alien_die",`${t}/alien_die.ogg`],["alien_engine",`${t}/alien_engine.ogg`],["alien_shoot",`${t}/alien_shoot.ogg`],["eye_accelerate",`${t}/eye_accelerate.ogg`],["eye_show",`${t}/eye_show.ogg`]].forEach(t=>{e.load.audio(t[0],t[1])})}},collision:{init(e){e.load.json("alien_boss-shape","images/enemy/boss.json"),e.load.json("alien_boss_eye-shape","images/enemy/boss_eye.json")}},fonts:{load(e){e.load.bitmapFont("heading","fonts/heading.png","fonts/heading.xml"),e.load.bitmapFont("default","fonts/default.png","fonts/default.xml")}},images:{available:[],header:"data:image/png;base64,",preA:"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCA",preB:"AAAAA6fptV[d]QIHW",postC:"AAAABJRU5ErkJggg==",postD:"AAAACklEQV",postE:"IAAACQd1Pe",postF:"AAAADElEQVR42m",postG:"AAAAAElFTkSuQmCC",base64s:{pixelblack:"[a][e][d]R4AWMAAgAABAABsYaQRA[c]",pixelwhite:"[a][b]P4DwABAQEANl9ngA[c]",pixel1:"[a][b]MQBAAAEwASIWsvQQ[c]",pixel2:"[a][b]NQAgAAJAAjw8NKCg[c]",pixel3:"[a][b]MwBgAANQA0TdMIeQ[c]",pixel6:"[a][b]NIAwAAaABnVJ+6Kw[c]",pixel9:"[a][b]OYCQAAmwCaKknZIA[c]",pixel15:"[a][b]MQBQAAFwAW6lOQIQ[c]",pixelC:"[a][b]M4AwAAzgDNUwEBJA[c]",pixelSea:"[a][e][f]NgtsgFAADqAKlXYE6o[g]",nightMask:"[a][e][f]NgcOsBAAEcANM3SJEq[g]"},init(e){let t=vars.files.images,a=e,s=t.base64s,i=t.header,n=t.preA,r=t.preB,o=t.postC,l=t.postD,h=t.postE,d=t.postF,p=t.postG;for(let c in s){let u=(i+s[c]).replace("[a]",n).replace("[b]",r).replace("[c]",o).replace("[d]",l).replace("[e]",h).replace("[f]",d).replace("[g]",p);a.textures.addBase64(c,u),t.available.push(c)}t.load(e)},load(e){let t="images";["player","clouds","backgrounds","enemy","gameObjects","earth"].forEach(a=>{e.load.atlas(a,`${t}/${a}/atlas.png`,`${t}/${a}/atlas.json`)}),e.load.spritesheet("explosion_boss","images/gameObjects/explosion_ext.png",{frameWidth:64,frameHeight:64,margin:1,spacing:2})}},music:{load(e){let t=vars.audio.musicTracks;["caprice.ogg","concerto_no1_bMin.ogg","dance_reed_flute.ogg","emperor_waltz.ogg","hall_mountain_king.ogg","hung_dance_5.ogg","minuet_g.ogg","night_music.ogg","romeo_juliet.ogg","sonata_c.ogg","toreadors_song.ogg"].forEach(a=>{let s=a.replace(".ogg","");e.load.audio(s,`music/${a}`),t.push(s)})}},particles:{load(e){let t="particles";["smoke","particles"].forEach(a=>{e.load.atlas(a,`${t}/${a}.png`,`${t}/${a}.json`)})}},plugins:{load(e){e.load.plugin("rexhsladjustpipelineplugin","plugins/rexhsladjustpipelineplugin.min.js",!0)}},loadAssets(){let e=vars.getScene();e.load.setPath("assets");let t=vars.files;t.audio.load(e),t.collision.init(e),t.fonts.load(e),t.images.init(e),t.particles.load(e),t.plugins.load(e),t.music.load(e)}},fonts:{small:{fontFamily:"Consolas",fontSize:"20px",color:"#ffffff",stroke:"#111111",strokeThickness:2,align:"center",lineSpacing:2},large:{fontFamily:"Consolas",fontSize:"28px",color:"#ffffff",stroke:"#111111",strokeThickness:3,align:"center",lineSpacing:10}},localStorage:{init(){window.localStorage}},getScene:()=>vars.game.Scene,audio:{tracks:{intro:["sonata_c"],earthGameplay:["caprice","minuet_g","night_music","toreadors_song"],spaceGameplay:["hall_mountain_king","concerto_no1_bMin","dance_reed_flute"],boss:["hung_dance_5"],playerDeath:["romeo_juliet"],win:["emperor_waltz"],playing:null},musicTracks:[],player:{engine:null,shoot:null,destroyed:null},init(){vars.DEBUG&&console.log("Audio init()");vars.getScene().sound.volume=.2},playSound(e){vars.DEBUG&&console.log(` > Audio > playSound > ${e}`),vars.getScene().sound.play(e)},playTrack(e="intro"){let t=vars.audio.tracks,a=t[e],s=a.shift();return a.push(s),t.playing=vars.getScene().sound.add(s,{loop:!1}),t.playing.play(),t.playing},switchTrackType(e="earthGameplay"){let t=vars.getScene(),a=vars.audio;if(!Object.keys(a.tracks).includes(e))return!1;let s=a.tracks.playing,i=(s.duration-s.getCurrentTime())*1e3;return t.tweens.addCounter({from:1,to:0,duration:i<=1e3?i-1:1e3,onUpdate(e,t){s.volume=t.value},onComplete(){s.stop(),s.destroy();a.playTrack(e).on("complete",()=>{a.playTrack(e)})}}),!0}},camera:{danger:null,game:null,init(){vars.DEBUG&&console.log("Camera init()");let e=vars.getScene();vars.camera.game=e.cameras.main,vars.camera.game.zoomIn=(t=!0)=>{let a=vars.camera.game;a.tween&&(a.tween.remove(),a.tween=null);let s=1.5,i=500;t||(s=1,i=1e3),a.tween=e.tweens.addCounter({from:a.zoom,to:s,duration:i,onUpdate(e,t){a.zoom=t.value},onComplete(){a.tween=null}})},vars.camera.initDangerCam()},initDangerCam(){let e=vars.camera,t=vars.getScene(),a=consts.canvas,s=t.add.container().setName("dangerContainer"),i=consts.depths.stars+1,n=t.add.image(a.width,a.cY,"earth","atmos").setScale(.2),r=t.add.image(a.width,a.cY,"earth","earth").setScale(.2),o=n.getTopRight(),l=t.add.image(o.x,o.y+10,"earth","glyph").setScale(.2),h=t.add.image(3*a.width,a.cY,"enemy","alien_boss").setOrigin(1,.5);vars.plugins.addHSLToObject(h,1);let d=h.getLeftCenter().x/64+1|0;d+=a.width/64;let p=a.height/64+1|0;console.log(`%cCols: ${d}. Rows: ${p}. Total: ${d*p}`,"color: #8bf8f4; font-size: 14px");let c=`Youve done well, little human.

Let me show you what youve been training for.`,u=vars.UI.dText=t.add.bitmapText(140,a.cY,"heading",c,48,0).setOrigin(.5).setTint(16711680).setAlpha(0).setDepth(consts.depths.alienUI),$=t.add.group({key:"gameObjects",frame:"danger_bg",setAlpha:{value:.2},setOrigin:{x:0,y:0},repeat:d*p-1});Phaser.Actions.GridAlign($.getChildren(),{width:d,cellWidth:64,cellHeight:64,x:-a.width/2,y:0}),s.add($.getChildren()),s.add([n,r,l,h,u]),s.setDepth(i);let g=4*a.height;s.y-=g;let m=e.danger=t.cameras.add(0,0,a.width,a.height);m.alpha=0,m.scrollY-=g,m.scrollX-=500,m.reset=()=>{m.scrollX=-500,m.zoom=1},m.sendHome=()=>{let e=consts.canvas,t=vars.getScene(),a=`Well Done!

It looks like youve managed to save your race... this time.

Hopefully we wont have to meet again.`,s=t.add.bitmapText(e.cX,e.cY,"heading",a,48,0).setOrigin(.5).setTint(16711680).setAlpha(0).setDepth(consts.depths.alienUI);t.tweens.add({targets:s,alpha:1,duration:1e3,hold:4e3,yoyo:!0,onComplete(){s.destroy();let a=e.cX,i=t.add.image(a,e.cY,"player","default_mid").setScale(.2);t.children.getByName("dangerContainer").add(i);let n=vars.camera.danger;n.scrollX=0,n.zoom=1,n.alpha=1,i.x=a,i.tweenBob=t.tweens.add({targets:i,y:i.y-5,duration:1e3,yoyo:!0,repeat:-1,ease:"Quad.easeInOut"}),n.zoomTo(5,2e3),i.tweenMove=t.tweens.addCounter({from:i.x,to:i.x+550,delay:3e3,duration:4e3,ease:"Quad.easeOut",onUpdate(e,t){i.x=t.value,n.scrollX=i.x-a},onComplete(){i.tweenBob.remove(),delete i.tweenBob,i.tweenMove=t.tweens.add({targets:i,x:i.x+60,y:r.y-24,scale:0,duration:2e3,ease:"Quad.easeOut",onComplete(){delete i.tweenMove,t.tweens.addCounter({from:1,to:0,duration:3e3,onUpdate(e,t){n.alpha=t.value},onComplete(){console.log("%cDone!","color: #20ff20; font-weight: bold; font-size: 16px"),i.destroy(),vars.UI.gameComplete.container.show()}})}})}})}})},m.showDanger=()=>{m.tween=t.tweens.addCounter({from:0,to:r.x-a.width/2,duration:4e3,ease:"Quad.easeOut",onUpdate(e,t){m.scrollX=t.value},onComplete(){t.tweens.addCounter({from:0,to:1,duration:1e3,onComplete(){m.zoomTo(2,500),t.tweens.addCounter({from:0,to:1,duration:1e3,onComplete(){m.zoomTo(4,333),t.tweens.addCounter({from:0,to:1,duration:2500,onComplete(){m.zoomTo(1,500),t.tweens.addCounter({from:0,to:1,duration:500,onComplete(){t.tweens.addCounter({from:m.scrollX,to:2560,duration:4e3,hold:500,ease:"Quad.easeInOut",onUpdate(e,t){m.scrollX=t.value},onComplete(){t.tweens.addCounter({from:1,to:.2,duration:1500,onUpdate(e,t){vars.plugins.getHSLForObject(h).setSatAdjust(t.value)},onComplete(){u.x=3170,u.show(1)}})}})}})}})}})}})}})};let y=e.game;u.show=(e=0)=>{switch(e){case 0:let a=0;vars.game.getPlayers().forEach((e,t)=>{let s=e.pushPlaneToPosition({x:75,y:(t+1)*100+200});s>a&&(a=s)}),t.tweens.addCounter({from:0,to:1,duration:1250,onUpdate(e,t){m.alpha=t.value,y.alpha=1.1-t.value},onComplete(){u.tween=t.tweens.add({targets:u,alpha:1,delay:a,duration:1e3,hold:3e3,yoyo:!0,onComplete(){delete u.tween,u.setText(`This is Galdragons Witness - Eater of Worlds

Your "World War" has attracted an enemy you werent ready for.

Thats why I plucked you from your one man attack against those nazis.

Destroy Galdragons Witness and save your planet.

You are Earths only chance for a future...

No Pressure.`),m.showDanger()}})}});break;case 1:u.tween=t.tweens.add({targets:u,alpha:1,duration:1e3,hold:5e3,yoyo:!0,onComplete(){t.tweens.addCounter({from:m.alpha,to:0,duration:1e3,onUpdate(e,t){m.alpha=t.value},onComplete(){m.reset(),y.tween=t.tweens.addCounter({from:.2,to:1,duration:1e3,onUpdate(e,t){y.alpha=t.value},onComplete(){delete y.tween,u.x=140,vars.input.enabled=!0,vars.game.spaceSim.introduceBoss()}})}})}})}}},flash(e=100,t=255,a=0,s=0){vars.camera.game.flash(e,t,a,s)},shake(e=1e3){vars.camera.game.shakeEffect.isRunning||(vars.DEBUG&&console.log(" > Camera > shake"),vars.camera.game.shake(e))}},game:{enemyGenerator:null,enemyGroups:null,level:null,pickupGen:null,playerCount:1,player1:null,player2:null,spaceSim:null,weather:null,UI:null,Phaser:null,Scene:null,init(){vars.DEBUG&&console.log("Game init()");let e=vars.physics;e.init(),e.pause()},cheat(e){"skip_level"===e&&vars.game.enemyGenerator.skip()},getDistanceTo:(e,t)=>Phaser.Math.Distance.BetweenPoints({x:e.x,y:e.y},{x:t.x,y:t.y}),getPlayerID:()=>vars.game.player1?2:1,getPlayers(){let e=vars.game;return e.player2?[e.player1,e.player2]:[e.player1]},playersAlive(){let e=!1;return[1,2].forEach(t=>{let a=vars.game[`player${t}`];a&&a.alive&&(e=!0)}),e},showDanger(){vars.input.enabled=!1,vars.UI.dText.show()},start(){let e=vars.game,t=vars.UI;e.enemyGroups=new EnemyGroup;let a=consts.canvas,s=.25*a.width,i=.33*a.height;for(let n=1;n<=e.playerCount;n++){let r=`player${n}`;e[r]=new Player({x:s,y:i}),t.layers[r]=new UILayer(r),e[r].layer=t.layers[r],i+=.33*a.height}e.level=new Level,e.pickupGen=new PickUpGenerator,e.weather=new WeatherSystem,e.spaceSim=new SpaceSim,vars.UI.layers.playerIntroText=new UILayer("playerIntroText")},startEnemyWaves(){vars.game.enemyGenerator&&(vars.game.enemyGenerator=null),vars.game.enemyGenerator=new EnemyGenerator},win(){let e=vars.game;[1,2].forEach(t=>{let a=e[`player${t}`];a&&(a.engineQuiet(),a.alive=!1,a.show(!1,1e3))});let t=vars.game.spaceSim.hideParallaxLayers();vars.UI.gameComplete.updateGameOverScreen(),scene.tweens.addCounter({from:0,to:1,duration:t,onComplete(){vars.camera.danger.sendHome()}})}},input:{enabled:!1,isEnabled:()=>vars.input.enabled,init(){vars.DEBUG&&console.log("Input init()"),vars.input.initCombos()},initCombos(){let e=vars.getScene().input.keyboard;e.createCombo("skip",{resetOnMatch:!0}),e.on("keycombomatch",function(e){let t="";e.keyCodes.forEach(e=>{t+=String.fromCharCode(e)}),"SKIP"===t&&vars.game.cheat("skip_level")})}},intro:{tempContainer:null,init(){let e=vars.getScene(),t=consts.depths.intro,a=vars.intro.tempContainer=e.add.container().setDepth(t);a.created=new Date;let s=consts.canvas,i=e.add.image(s.cX,s.cY,"loadingScreen");a.add(i)},addStartButton(){let e=consts.canvas,t=vars.getScene(),a=vars.intro.tempContainer,s=t.add.image(e.cX,.85*e.height,"gameObjects","start_button").setAlpha(0);a.add(s),s.tween=t.tweens.add({targets:s,alpha:1,duration:500,onComplete(){delete s.tween,s.setInteractive(),s.on("pointerup",()=>{vars.intro.destroy()})}})},destroy(){vars.intro.tempContainer.destroy(),vars.game.start()}},plugins:{addHSLToObject(e,t=.2){vars.getScene().plugins.get("rexhsladjustpipelineplugin").add(e,{satAdjust:t})},getHSLForObject:e=>vars.getScene().plugins.get("rexhsladjustpipelineplugin").get(e)[0]},physics:{isPaused:!0,timeScale:1,categories:{player:null,enemy:null,playerBullets:null,enemyBullets:null,ready:!1},init(){let e=vars.physics,t=vars.getScene(),a=e.categories,s=vars.physics.getNextCategory();a.player=s,a.enemy=s,a.playerBullets=s,a.enemyBullets=s,t.matter.world.on("collisionstart",function(e,t,a){let s,i;if(!t.name||!a.name){if(!t.gameObject.name||!a.gameObject.name)return;s=t.gameObject.name,t=t.gameObject.body,i=a.gameObject.name,a=a.gameObject.body}if(s||(s=t.name),i||(i=a.name),!((s.startsWith("eBullet_")||i.startsWith("eBullet_"))&&(s.startsWith("enemy_")||i.startsWith("enemy_")))){if((s.startsWith("p1Bullet_")||i.startsWith("p1Bullet_"))&&(s.startsWith("enemy_")||i.startsWith("enemy_"))){let n=vars.game.player1,r=null,o=null;if(s.startsWith("enemy_")?(r=t,o=a):(r=a,o=t),!r.alive)return;console.log(`Collision between: bullet and enemy ${r.name}`);let l=r.name;if(o.name.endsWith("_r")||n.destroyBulletByName(o.name),l.includes("_boss_")){vars.game.spaceSim.boss.hit(o.damage),n.scoreIncrease(o.damage*consts.scoreMult);return}r.hp-=o.damage;let h=0|l.split("_")[2].replace("g",""),d,p=!1;if(991989===h){p=!0;if(!(d=vars.game.enemyGroups.getEnemyClassByEnemyName(l)).class){console.error("Enemy wasnt found!");return}}else if(!(d=vars.game.enemyGroups.groups[h].find(e=>e.name===l))){console.error("Enemy wasnt found!");return}if(n.scoreIncrease(o.damage*consts.scoreMult),p?d.class.hit(d.set):d.hit(),r.hp)return;if(p?d.class.die(1,d.set):d.die(1,h),p){let c=d.class.set;c[d.set]=null,d.class.set=c.filter(e=>null!==e),d.class.set.length}return}if((s.startsWith("eBullet_")||i.startsWith("eBullet_"))&&(s.startsWith("player_")||i.startsWith("player_"))){let u=vars.game,$,g;s.startsWith("player_")?($=t,g=a):($=a,g=t);let m=u[`player${0|$.name.replace("player_","")}`],y=g.damage;if(m.hit(y),g.name.includes("_boss_mouth_"))return;let w=u.enemyGroups.bulletGroup.getChildren().find(e=>e.body.name===g.name);if(!w){console.error(`Bullet with name ${g.name} not found!`);return}w.destroy();return}if(("upgrade"===s||"upgrade"===i)&&(s.startsWith("player_")||i.startsWith("player_"))){let f,_;"upgrade"===s?(f=t,_=a):(f=a,_=t);let v=0|_.name.replace("player_","");if(_=vars.game[`player${v}`],"hp"!==f.upgradeType&&_.isUpgraded())return;vars.game.pickupGen.pickUp(_,f);return}if((s.startsWith("p1Bullet_")||i.startsWith("p1Bullet_"))&&(s.startsWith("eBullet_")||i.startsWith("eBullet_"))){let b,x;if(s.startsWith("p1Bullet")?(x=t,b=a):(x=a,b=t),b.name.includes("boss_eye")||b.name.includes("boss_mouth"))return;if(vars.game.spaceSim.enabled){let S=vars.game.enemyGroups.bulletGroup.getChildren().find(e=>e.name===b.name);S&&S.destroy()}return}}})},getNextCategory:()=>vars.getScene().matter.world.nextGroup(!0),pause(e=!0){let t=vars.getScene();e?t.matter.pause():t.matter.resume(),vars.physics.isPaused=e,vars.DEBUG&&console.log(`%cPhysics has been ${e?"paused":"unpaused"}`,`color: ${e?"red":"green"}`)},slowDownTime(e=!0){let t=vars.getScene(),a=e?.1:1;t.matter.world.engine.timing.timeScale=a,vars.physics.timeScale=a}},UI:{gameComplete:null,layers:{},dText:null,init(){let e=vars.UI;e.gameComplete=new UILayer("gameComplete"),vars.DEBUG&&(e.debug=new UILayer("debug"))}}};"use strict";"use strict";"use strict";"use strict";"use strict";"use strict";let AlienEnemy=class{constructor(e){this.cC=consts.canvas,this.scene=vars.getScene(),this.availableAlienColours=this.scene.textures.get("enemy").getFrameNames().filter(e=>e.startsWith("alien_")).filter(e=>!e.endsWith("bullet")).filter(e=>!e.endsWith("head")).filter(e=>!e.endsWith("boss")),this.colour=e.colour||getRandom(this.availableAlienColours),this.shootVars={canShoot:!1,timeout:null,timeoutMax:120,bulletCount:e.bulletCount},this.ys=checkType(e._y,"array")?e._y:[e._y],this.audio={engine:this.scene.sound.add("alien_engine",{loop:!0})},this.scale=.5,this.enemyCount=e.count,this.cat=vars.physics.categories.enemy,this.bulletGroup=vars.game.enemyGroups.bulletGroup,this.specialType=e.specialType,this.set=[],this.ys.forEach(t=>{let a=e.delay;for(let s=0;s<this.enemyCount;s++){let i=this.enemyCount<=4?20*s:5===this.enemyCount?15*s:10*s,n=s*a,r=this.init(t,i,n);this.set.push(r),this.specialType&&(this.specialType,this.specialType)}})}init(e,t,a=1e3){let s=this.scene,i=vars.game.enemyGroups.alienGroup;"random"===e&&(e=getRandom(1,6));let n=100*e+60+t;this.name="enemy_"+generateRandomID()+"_g991989";let r=s.add.image(0,n,"enemy",`alien_${this.colour}`).setDepth(consts.depths.enemies-1).setScale(this.scale/2).setName(this.name);return r.x=-r.displayWidth/2,r.colour=this.colour,vars.plugins.addHSLToObject(r),this.addIntroTween(a,r),i.add(r),r}addIntroTween(e,t){let a=this.cC,s=this.scene,i=t,n=a.width+i.displayWidth/2;i.introTween=s.tweens.add({targets:i,x:n,delay:e,duration:2e3,onComplete:()=>{if(!vars.game.playersAlive())return;delete i.introTween,i.resetPostPipeline(),i.setScale(.5).setFlipX(!0).setPosition(a.width+i.displayWidth/2,i.y).setDepth(i.depth+1),s.matter.add.gameObject(i),i.setBody({type:"rectangle",width:68.5,height:52}).setSensor(!0).setFriction(0,0).setVelocityX(-2.5),i.setCollisionGroup(this.cat);let e=i.body;e.name=i.name,this.initShootVars(i),e.alive=!0,e.hp=10,i.tween=s.tweens.add({targets:i,angle:{from:-25,to:25},duration:1e3,yoyo:!0,repeat:-1,ease:"Quad.easeInOut"})}})}initShootVars(e){let t={...this.shootVars};t.timeout=10*getRandom(2,6),t.timeoutMax=10*getRandom(10,18),t.canShoot=!1,e.shootVars=t}die(e,t){let a=this.set[t];a.tween&&a.tween.remove(),a.body.alive=!1,vars.audio.playSound("alien_die"),this.scene.tweens.add({targets:a,alpha:0,scale:0,delay:75,duration:250,onComplete(){a.destroy()}})}hit(e){let t=this.set[e];t.flashTween&&(t.flashTween.remove(),t.clearTint()),t.setTintFill(16777215),t.flashTween=vars.getScene().tweens.addCounter({from:0,to:1,duration:33,onComplete(){t.clearTint(),delete t.flashTween}})}shoot(e){let t=this.scene,a=`alien_${e.colour}_bullet`,s=e.x-60,i=e.shootVars.bulletCount,n=i%2?i/2|0:i/2-1+.5,r=-1*n;for(let o=n;o>=r;o--){let l=e.y-55*o,h=generateRandomID(),d=t.add.image(s,l,"enemy",a).setDepth(consts.depths.bullets).setAlpha(0).setScale(.5).setName(`eBullet_${h}`);this.bulletGroup.add(d),d.updatePosition=()=>{if(!e||!e.body){delete d.updatePosition,d.destroy();return}d.x=e.x-60},this.scene.tweens.add({targets:d,alpha:1,duration:500,onComplete(){if(d.updatePosition&&delete d.updatePosition,!e||!e.body){d&&d.destroy();return}vars.audio.playSound("alien_shoot"),t.matter.add.gameObject(d),d.setSensor(!0).setFriction(0,0),d.body.name=d.name,d.body.damage=3;let a=vars.game.player1.object,s=180*(Math.PI/180);a.x<d.x&&(s=Phaser.Math.Angle.BetweenPoints({x:d.x,y:d.y},{x:a.x,y:a.y})),d.rotation=s,d.thrust(.02)}})}}update(){this.set.forEach((e,t)=>{if(e){if(e.body&&e.body.alive){if(e.x<-e.displayWidth/2){e.tween.remove(),e.destroy(),this.set[t]=null;return}let a=e.shootVars;a.timeout--,!a.timeout&&(a.timeout=a.timeoutMax,this.shoot(e))}else e[t]=null}}),this.set=this.set.filter(e=>null!==e)}},Enemy=class{constructor(e){this.x=e.x,this.delay=e.delay,this.yVars=e.yVars,this.groupID=e.groupID,this.colour=e.colour,this.res={intro:.25,normal:.5},this.audio={engine:null,shoot:null},this.preInit(),this.shootVars={canShoot:!1,timeout:null,timeoutMax:120,bulletCount:2},this.bulletGroup=vars.game.enemyGroups.bulletGroup,this.init()}preInit(){this.cat=vars.physics.categories.enemy,this.initAudio()}init(){let e=consts.canvas,t=vars.getScene(),a=generateRandomID();this.name=`enemy_${a}_g${this.groupID}`;let s=this.object=t.add.sprite(0-this.x,0,"enemy",this.colour).setDepth(consts.depths.enemies-1).setVisible(!0).setScale(this.res.intro);s.x=-s.displayWidth/2,s.setName(this.name),vars.plugins.addHSLToObject(s);let i=this.res.normal,n=this.yVars.padding/2,r=this.yVars.yStart;s.setPosition(0,2*n+r/2),this.score=5*consts.scoreMult,this.audio.engine.play(),s.introTween=t.tweens.add({targets:s,x:consts.canvas.width+s.displayWidth/2,duration:4e3,delay:this.delay,onComplete:()=>{if(!vars.game.playersAlive())return;delete s.introTween;let a=r+n;s.setScale(i).setFlipX(!0).setPosition(e.width,a).setDepth(s.depth+1),t.matter.add.gameObject(s),s.setBody({type:"rectangle",width:118.5,height:57.5}).setSensor(!0).setFriction(0,0).setVelocityX(-4),s.setCollisionGroup(this.cat);let o=s.body;o.name=s.name,o.hp=5,s.resetPostPipeline(),s.tweenBob=t.tweens.add({targets:s,y:a-30,duration:1e3,repeat:-1,yoyo:!0,ease:"Quad.easeInOut"}),this.initShootVars(),o.alive=!0}})}initAudio(){let e=vars.getScene();this.audio={engine:e.sound.add("plane_engine",{loop:!0,volume:.1}),shoot:e.sound.add("plane_shoot",{loop:!1,volume:.1})}}initShootVars(){this.shootVars.timeout=10*getRandom(2,6),this.shootVars.canShoot=!1}createBullet(e){let t=this.object,a=vars.getScene(),s=this.bulletGroup;a.tweens.addCounter({from:0,to:1,duration:e,onComplete:()=>{if(!t||!t.body||!t.body.alive)return;let e=vars.game.player1,i=e.playerVars.scale,n={x:t.x-50,y:t.y-10};if(t.x<25||t.x-e.object.x<100)return!1;let r=a.matter.add.image(n.x,n.y,"enemy","bulletEnemy",{isSensor:!0}).setScale(i).setDepth(consts.depths.bullets).setFlipX(!0).setFriction(0,0).setCollisionCategory(this.cat),o=generateRandomID();r.body.name=`eBullet_${o}`,r.body.damage=5,s.add(r),r.setVelocityX(-10),this.audio.shoot.isPlaying||this.audio.shoot.play()}})}deathAnimation(e,t){let a=vars.game.player1.anims,s=t,i=this.name,n=this.object,r=n.body;r.alive=!1;let o=vars.game.enemyGroups;this.killedByPlayer=e;let l=vars.game[`player${e}`];l.scoreIncrease(this.score*consts.scoreMult),l.kills++,n.tweenBob.remove(),delete n.tweenBob;let h=vars.getScene();h.tweens.addCounter({from:0,to:1,useFrames:!0,duration:1,onComplete(){r.force.y=.01}}),n.play(a.damaged.death),n.deathTween=h.tweens.addCounter({from:0,to:1,duration:2e3,onComplete(){n.deathTween=h.tweens.add({targets:n,alpha:0,duration:250,onComplete(){o.removeEnemyFromGroup(i,s)}})}})}die(e,t){vars.audio.playSound("plane_explode"),this.deathAnimation(e,t);let a=this.audio;a.engine.stop(),a.engine.destroy()}hit(){let e=this.object;e.flashTween&&(e.flashTween.remove(),e.clearTint()),e.setTintFill(16777215),e.flashTween=vars.getScene().tweens.addCounter({from:0,to:1,duration:33,onComplete(){e.clearTint(),delete e.flashTween}})}shoot(e){this.createBullet(e)}update(){if(!this.object.body||!this.object.body.alive)return!1;let e=this.shootVars;if(e.timeout--,!e.timeout){e.timeout=e.timeoutMax;for(var t=0;t<e.bulletCount;t++)this.shoot(100*t)}}},EnemyGenerator=class{constructor(){this.currentLevel=0,this.waitingForBossDeath=!1,this.levelChanging=!1,this.levels=[{level:1,distanceBetweenGroupsInMetres:125,nextSpawnDistance:50,enemyGroups:[{type:"horizontal",count:3,delay:1500,_y:1,colour:"blue"}],onComplete:["dayToNight","fog50"]},{level:2,distanceBetweenGroupsInMetres:100,nextSpawnDistance:null,enemyGroups:[{type:"vertical",count:4,delay:1e3,colour:"blue"},{type:"vertical",count:6,delay:750,colour:"black"}],onComplete:["nightToDay","fog10"]},{level:3,distanceBetweenGroupsInMetres:75,nextSpawnDistance:null,enemyGroups:[{type:"vertical",count:4,delay:1e3,colour:"blue"},{type:"horizontal",count:3,delay:1250,_y:"random",colour:"blue"}],onComplete:["breakReality"]},{level:4,distanceBetweenGroupsInMetres:50,nextSpawnDistance:null,enemyGroups:[{type:"default",count:4,bulletCount:2,delay:750,colour:"yellow",_y:1,specialType:null}],onComplete:[]},{level:5,distanceBetweenGroupsInMetres:40,nextSpawnDistance:null,enemyGroups:[{type:"default",count:2,bulletCount:3,delay:1250,colour:"blue",_y:[1,2,3],specialType:null}],onComplete:["introduceSpaceTech"]},{level:6,distanceBetweenGroupsInMetres:30,nextSpawnDistance:null,enemyGroups:[{type:"default",count:4,bulletCount:3,delay:1250,colour:"blue",_y:[1,2,3],specialType:null}],onComplete:["introduceSpaceTech2"]},{level:7,distanceBetweenGroupsInMetres:30,nextSpawnDistance:null,enemyGroups:[{type:"default",count:4,bulletCount:3,delay:1250,colour:"blue",_y:[1,2,3],specialType:null}],onComplete:["introduceBoss"]},{level:8,distanceBetweenGroupsInMetres:10,nextSpawnDistance:null,enemyGroups:[{type:"boss"}],onComplete:["gameComplete"]}]}doLevelOnCompletes(){let e=this.getLevelOnCompletes();checkType(e,"array")||(e=[e]);let t=vars.game,a="color: #20ff20",s=!1;e.forEach(e=>{let i=!1;if(e.startsWith("fog")){let n=(0|e.replace("fog",""))/100;vars.DEBUG&&console.log(`%cSetting the fog alpha to ${n}`,a),i=!0,t.weather.fogFadeIn(!0,n,3e3)}if("dayToNight"===e&&(vars.DEBUG&&console.log("%cChanging from day to night",a),i=!0,t.level.startNightTime()),"introduceBoss"===e&&(vars.DEBUG&&console.log("%cIntroducing the BOSS!",a),i=!0,s=!0,vars.game.showDanger()),"introduceSpaceTech"===e){let r=vars.game.spaceSim;r.showParallaxLayer("upper"),r.showParallaxLayer("lower"),s=!0,i=!0}if("introduceSpaceTech2"===e&&(vars.game.spaceSim.showParallaxLayer("background"),s=!0,i=!0),"nightToDay"===e&&(vars.DEBUG&&console.log("%cChanging from night to day",a),i=!0,t.level.startNightTime(!1)),"breakReality"===e&&(vars.game.spaceSim.generateFoos(),s=!0,i=!0),"gameComplete"===e&&(vars.DEBUG&&console.log("%cGame complete has been hit. Boss has spawned. Waiting for it to die.",a),vars.DEBUG&&console.log(`%c \
                
*****************\
                
* GAME COMPLETE *\
                
*****************`,a),i=!0),!i)return console.error(`"${e}" doesnt have a handler!`),!1}),this.levelChanging=!1;let i=t.player1.playerVars,n=this.levels[this.currentLevel];s?n.nextSpawnDistance=i.distanceTravelled+5e3:n.nextSpawnDistance=i.distanceTravelled+n.distanceBetweenGroupsInMetres}generateNextWave(e){let t=vars.game.enemyGroups;if("default"===e.type){t.newAlienSet(e);return}let a=vars.game.enemyGroups.availableEnemyColours,s=e.count,i=e.delay,n=`enemy_${e.colour}`;if(!checkType(s,"int")||!checkType(i,"int")||!a.includes(n)){console.warn(`Invalid count (${s}), delay (${i}) or colour (${n})!`);return}switch(e.type){case"vertical":t.newVerticalSet(s,i,n);break;case"horizontal":let r=vars.game.enemyGroups.availableYOptions,o=e._y;if(!r.includes(o)){console.warn("Invalid _y!");return}t.newHorizontalSet(s,i,n,o);break;default:console.warn(`Unknown wave type "${e.type}"`)}}getLevelOnCompletes(){return this.levels[this.currentLevel-1].onComplete}getNextLevel(){if(!this.waitingForBossDeath){if(this.currentLevel++,!this.levels[this.currentLevel]){console.log(`No More Levels Left!
Waiting for boss death.`),this.waitingForBossDeath=!0;return}this.levelChanging=!0}}setNextSpawnPosition(){let e=vars.game.player1.playerVars,t=this.levels[this.currentLevel];t.nextSpawnDistance=e.distanceTravelled+t.distanceBetweenGroupsInMetres}skip(){if(this.levelChanging)return;let e=this.levels[this.currentLevel],t=e.enemyGroups.length;e.enemyGroups=[],console.log(`âœ” %cSkipping level. Removed ${t} groups of enemies.`,"color: #ff8000")}update(){if(this.levelChanging||!this.levels[this.currentLevel]||this.waitingForBossDeath)return;let e=vars.game.player1;if(!vars.game.playersAlive())return;let t=this.levels[this.currentLevel];if(e.playerVars.distanceTravelled<t.nextSpawnDistance)return;let a=t.enemyGroups;if(a.length||this.getNextLevel(),this.levelChanging||this.waitingForBossDeath)return;let s=a.shift();this.generateNextWave(s),t.nextSpawnDistance+=t.distanceBetweenGroupsInMetres}},EnemyGroup=class{constructor(){this.preInit(),this.init()}preInit(){let e=vars.getScene();this.availableYOptions=["random","lower","upper",1,2,3,4,5,6],this.availableEnemyColours=e.textures.list.enemy.getFrameNames().filter(e=>e.startsWith("enemy_")),this.groups=[],this.bulletGroup=e.add.group(),this.alienGroups=[],this.alienGroup=e.add.group()}init(){}destroyAll(){this.destroyAllEnemies()}destroyAllEnemies(){vars.DEBUG&&console.log("%cDestroying all enemies","color: red; font-weight: bold"),this.groups.forEach(e=>{e.forEach(e=>{e.audio.engine.stop(),e.object.introTween&&(e.object.introTween.remove(),delete e.object.introTween),e.object.tweenBob&&(e.object.tweenBob.remove(),delete e.object.tweenBob),e.object.destroy(),e=null}),e=null}),this.groups=[]}getEnemyClassByEnemyName(e){let t=!1,a=[],s=this.alienGroups;return s.forEach((s,i)=>{if(!1===t){let n=s.set.findIndex(t=>t.name===e);-1!==n&&(a.push(n,i),t=!0)}}),!!a.length&&{class:s[a[1]],set:a[0]}}getGroupByID(e=null){return this.groups[e]}newVerticalSet(e=1,t=0,a="blue"){e>6&&(e=6);let s={padding:120,yMult:null,yStart:null},i=[],n=this.groups.length;for(var r=0;r<e;r++){let o=r*t,l=r+1;s.yMult=l,s.yStart=100*l;let h=new Enemy({x:0,yVars:s,delay:o,groupID:n,colour:a});i.push(h)}this.groups.push(i)}newAlienSet(e){this.alienGroups.push(new AlienEnemy(e))}newHorizontalSet(e,t=1e3,a="blue",s="random"){if(!this.availableYOptions.includes(s))return console.error(`Invalid _y passed (${s}).
Available options are:`,this.availableYOptions.join("/")),!1;let i={padding:120,yMult:null,yStart:null},n;switch(s){case"random":n=getRandom(1,6);break;case"upper":n=getRandom(1,3);break;case"lower":n=getRandom(4,6);break;default:n=s}let r=100*n;i={...i,yMult:n,yStart:r};let o=[],l=this.groups.length;for(var h=0;h<e;h++){let d=250*h,p=h*t,c=new Enemy({x:d,yVars:i,delay:p,groupID:l,colour:a});o.push(c)}this.groups.push(o)}newVSet(e,t=!1){}removeEnemyFromGroup(e,t){let a=this.getGroupByID(t);if(!a)return!1;let s=a.findIndex(t=>t.object.name===e),i=a[s],n={x:i.object.x,y:i.object.y},r=i.score;if(a.splice(s,1),i.object.destroy(),a.length)return;let o=i.killedByPlayer;vars.game[`player${o}`].scoreIncrease(2*r),vars.game.pickupGen.createRandomUpgrade(n)}update(e){!vars.game.enemyGenerator.waitingForBossDeath&&(e||this.updateEnemyGroups(),e&&this.updateAlienSets()),this.updateEnemyBulletGroup()}updateAlienSets(){this.alienGroups.forEach((e,t)=>{!e.name.includes("_boss_")&&(e.update(),e.set.length||(this.alienGroups[t]=null))}),this.alienGroups=this.alienGroups.filter(e=>null!==e);let e=vars.game.enemyGenerator;e.levels[e.currentLevel].enemyGroups.length,!this.alienGroups.length&&e.levelChanging&&e.doLevelOnCompletes()}updateEnemyBulletGroup(){this.bulletGroup.getChildren().forEach(e=>{e.x<0&&e.destroy(),e.updatePosition&&e.updatePosition()})}updateEnemyGroups(){this.groups.forEach((e,t)=>{e.forEach((e,a)=>{if(e){let s=e.object;s.body&&s.x<-s.displayWidth/2&&s.body.alive&&(s.tweenBob&&(s.tweenBob.remove(),delete s.tweenBob),e.audio.engine.stop(),e.audio.engine.destroy(),s.destroy(),this.groups[t][a]=null)}}),e.forEach((e,a)=>{null===e&&this.groups[t].splice(a,1),!this.groups[t].length&&vars.DEBUG&&console.log(`Group ${t} is now empty!`)})});let e=0;this.groups.forEach((t,a)=>{t.forEach(t=>{t&&(t.update(),e++)})});let t=vars.game.enemyGenerator;!e&&t.levelChanging&&t.doLevelOnCompletes()}},Level=class{constructor(){this.preInit(),this.depth=this.depths.game,this.isPaused=!0,this.spaceSim=!1,this.init()}preInit(){this.cC=consts.canvas,this.depths=consts.depths,this.firstGame=!0,this.isNightTime=!1;let e=vars.getScene();this.clouds=e.textures.get("clouds").getFrameNames(),this.cloudsContainer=e.add.container().setDepth(this.depths.clouds)}init(){this.generateParallaxLayers()}reset(){this.isPaused=!0}restart(){this.layers.forEach(e=>{e.x=0}),this.startNightTime(!1)}start(){this.firstGame&&this.doOnce(),[1,2].forEach(e=>{let t=vars.game[`player${e}`];t&&t.show(!0)}),vars.physics.pause(!1),this.firstGame=!1,this.isPaused=!1}stop(){}addCloudLayers(){if(this.cloudLayersVars)return;let e=vars.getScene();this.cloudLayersVars={near:{initialCount:2,scale:1,duration:8e3,y:.3*this.cC.height},middle:{initialCount:3,scale:.8,duration:16e3,y:.5*this.cC.height},far:{initialCount:2,scale:.6,duration:24e3,y:.6*this.cC.height}},["near","middle","far"].forEach(t=>{let a=this.cloudLayersVars[t];for(let s=0;s<a.initialCount;s++){let i=getRandom(this.clouds),n=e.add.image(this.cC.width,a.y,"clouds",i).setScale(a.scale);n.setName(`cL_${t}`);let r=n.displayWidth/2;n.x+=r;let o=-r;n.tween=e.tweens.add({targets:n,x:o,duration:a.duration,delay:a.duration/a.initialCount*s,onComplete(){n.destroy();let e=n.name.replace("cL_","");vars.game.level.addCloudToLayer(e)}}),this.cloudsContainer.add(n)}})}addCloudToLayer(e){if(!this.cloudsContainer.alpha)return;let t=vars.getScene(),a=getRandom(this.clouds),s=this.cloudLayersVars[e],i=t.add.image(this.cC.width,s.y,"clouds",a).setScale(s.scale);i.setName(`cL_${e}`);let n=i.displayWidth/2;i.x+=n,i.tween=t.tweens.add({targets:i,x:-n,duration:s.duration,onComplete(){i.destroy();let e=i.name.replace("cL_","");vars.game.level.addCloudToLayer(e)}}),this.cloudsContainer.add(i)}generateParallaxLayers(){let e=vars.getScene();this.layers=[];let t="backgrounds",a=1920,s=this.cC.width/a;a*=s,this.layerDepths=[],[0,1,2,3].forEach(i=>{let n=i+2+2*i;this.layerDepths.push(n);let r=e.add.container().setDepth(n);r.speed=2/(i+1),this.layers.push(r);let o=i.toString(),l=e.add.image(0,0,t,o).setScale(s).setOrigin(0),h=e.add.image(0+a,0,t,o).setScale(s).setOrigin(0);r.add([l,h])});let i=e.add.container().setName("fogContainer").setDepth(consts.depths.fog);i.speed=2,this.layers[4]=i;let n=e.add.image(0,0,t,"fog").setScale(s).setOrigin(0),r=e.add.image(0+a,0,t,"fog").setScale(s).setOrigin(0);i.add([n,r]);let o=consts.canvas,l=this.nightMask=e.add.image(o.cX,o.cY,"nightMask").setScale(o.width,o.height).setBlendMode(2).setDepth(consts.depths.nightMask).setAlpha(0);l.fadeIn=(t=!0)=>{l.tween=e.tweens.add({targets:l,alpha:t?1:0,duration:1e4})}}hideWar(){this.layers.forEach(e=>{e.alpha=0}),this.cloudsContainer.alpha=0,this.nightMask.alpha=0}dimTheForeground(e=!0){let t=vars.getScene(),a=this.fgContainer;a.tween&&(a.tween.remove(),a.tween=null);let s=e?{duration:5e3,alpha:1}:{duration:500,alpha:0};a.tween=t.tweens.add({targets:a,alpha:s.alpha,duration:s.duration,onComplete(){s.alpha,a.tween=null}})}doOnce(){delete vars.UI.layers.playerIntroText,this.addCloudLayers(),vars.game.player1.introduce()}increaseDifficulty(){}startNightTime(e=!0){this.isNightTime=e,this.nightMask.fadeIn(this.isNightTime)}update(){if(this.isPaused)return!1;let e=vars.game;if(!e.player1||!e.player1.alive)return!1;e.player1.update(),e.enemyGroups.update(this.spaceSim),e.enemyGenerator.update(),e.pickupGen.update(),e.spaceSim.update(),this.spaceSim||this.updateParallaxContainers(),vars.DEBUG&&vars.UI.debug.updateDebug()}updateParallaxContainers(){this.layers.forEach(e=>{e.x-=e.speed,e.x<-this.cC.width&&(e.x+=this.cC.width)})}},PickUpGenerator=class{constructor(e){this.scene=vars.getScene(),this.pickupDepth=consts.depths.pickups,this.initAnimations(),this.initTimer(),this.groups={hp:[],planeUpgrade:[]}}initAnimations(){let e=[0,1,2,3,4,5,6,7,8,9,10].reverse(),t=this.scene;t.anims.create({key:"timer",frames:t.anims.generateFrameNames("gameObjects",{prefix:"t",frames:e}),frameRate:1})}initTimer(){let e=consts.canvas,t=this.scene,a=this.pickUpTimer=t.add.sprite(e.cX,e.height-10).setOrigin(.5,1).setDepth(this.pickupDepth);a.show=(e=!0)=>{let s=e?1:0;a.tween=t.tweens.add({targets:a,alpha:s,duration:e?50:500,onComplete(){s&&a.play("timer"),delete a.tween}})},a.on("animationcomplete",()=>{let e=a.player;delete a.player,a.show(!1),vars.game[`player${e}`].upgradeStart(!1)})}newPickUpOfType(e,t){switch(e){case"hp":this.newHPPickUp(t);break;case"weapon":this.newPlaneUpgradePickUp(t)}}addAnimatedBob(e){let t=!checkType(e,"array"),a=t?e.y:e[0].y,s=this.scene.tweens.add({targets:e,duration:1e3,y:a-20,yoyo:!0,repeat:-1,ease:"Quad.easeInOut"});t?e.tween=s:e[0].tween=s}addForceToObject(e){e.setVelocityX(-1)}createRandomUpgrade(e){e.x&&e.y||console.error(`Invalid spawn position (${e.x},${e.y})`);let t=vars.game,a=[];[t.player1,t.player2].forEach(e=>{if(e){let t=e.playerVars;t.hp<=40?a=[...a,"10hp","25hp","25hp","50hp"]:t.hp<=65?a=[...a,"10hp","25hp"]:t.hp<=80&&(a=[...a,"10hp"])}}),a.length<=t.playerCount&&(a=[...a,"dblFireRate","dblSpeed","shield"]),vars.DEBUG&&console.table(a);let s=getRandom(a);if(vars.DEBUG&&console.log(`Selected ${s}`),s.includes("hp")){let i=0|s.replace("hp","");this.newPickUpOfType("hp",{hp:i,x:e.x,y:e.y})}else this.newPickUpOfType("weapon",{type:s,x:e.x,y:e.y})}destroyGroupByID(e,t){if(!this.groups[e])return console.error(`Invalid group type (${e})`),!1;let a=this.groups[e],s=a.findIndex(e=>e.id===t);if(s<0)return console.error(`Group with id ${t} wasnt found.`),!1;let i=a[s].group;i.getChildren().forEach(e=>{e.tween&&e.tween.remove()}),i.destroy(!0),this.groups[e].splice(s,1)}getUpgradeType(e){switch(e){case"dblFireRate":case"dblSpeed":case"shield":return"planeUpgrade";case"hp":return e}return!1}newGroup(){return this.scene.add.group()}newGroupID(){return generateRandomID()}newHPPickUp(e){let t=e.x,a=e.y,s=e.hp;if(!checkType(t,"number")||!checkType(a,"number"))return console.error(`HP Pickup requested with invalid position (x: ${t}, y: ${a})`),!1;if(![10,25,50].includes(s))return console.error(`HP Pickup requested with invalid hp (${s})`),!1;let i=this.scene,n=this.newGroupID(),r=this.newGroup();this.groups.hp.push({group:r,id:n});let o=i.matter.add.image(t,a,"gameObjects","hpUp").setName("upgrade").setFriction(0,0).setSensor(!0).setDepth(this.pickupDepth),l=o.body;l.name="upgrade",l.upgradeType="hp",l.groupID=n,l.hp=s;let h=i.add.image(t,a,"gameObjects",`hp${s}`).setDepth(this.pickupDepth+1);h.updatePosition=()=>{h.setPosition(o.x,o.y)},r.addMultiple([o,h]),this.addAnimatedBob([o,h]),this.addForceToObject(o)}newPlaneUpgradePickUp(e){let t=e.x,a=e.y;if(!checkType(t,"number")||!checkType(a,"number"))return console.error(`HP Pickup requested with invalid position (x: ${t}, y: ${a})`),!1;let s=e.type;if(!["dblFireRate","shield","dblSpeed"].includes(s))return console.error(`Invalid upgrade type (${s})`),!1;let i=this.newGroupID(),n=this.newGroup();this.groups.planeUpgrade.push({group:n,id:i});let r;switch(s){case"dblFireRate":r="doubleFireRate";break;case"shield":r="shield";break;case"dblSpeed":r="speedUp"}let o=this.scene.matter.add.image(t,a,"gameObjects",r).setName("upgrade").setFriction(0,0).setSensor(!0).setDepth(this.pickupDepth),l=o.body;l.name="upgrade",l.upgradeType=s,l.groupID=i,n.add(o),this.addAnimatedBob(o),this.addForceToObject(o)}pickUp(e,t){let a=e,s=t,i=this.getUpgradeType(s.upgradeType);switch(vars.audio.playSound("pickup"),s.upgradeType){case"dblFireRate":a.upgrades.dblFireRate=!0;break;case"dblSpeed":a.upgrades.dblSpeed=!0;break;case"hp":let n=t.hp;a.hpIncrease(n);break;case"shield":a.upgrades.shield=!0}"planeUpgrade"===i&&(this.startTimer(a.id),a.upgradeStart());let r=s.groupID;this.destroyGroupByID(i,r)}startTimer(e){this.pickUpTimer.show(),this.pickUpTimer.player=e}update(){this.updateHPGroups()}updateHPGroups(){this.groups.hp.forEach(e=>{e.group.getChildren().forEach(e=>{e.updatePosition&&e.updatePosition()})})}},Player=class{constructor(e={x:.25*consts.canvas.width,y:consts.canvas.cY}){this.startPosition=e,this.type="player",this.id=vars.game.getPlayerID(),this.isShooting=!1,this.playerVars={lives:3,hp:100,hpMax:100,alive:!1,onFire:!1,smokeTimer:1,smokeTimerMin:10,smokeTimerMax:20,defaultFrame:"default_mid",scale:.5,speedX:6,speedY:6,speedMult:1,shootDelay:0,shootDelayMax:5,shootDelayReduction:0,shield:!1,distanceTravelled:0,distanceInMetresEveryFrame:.5555,width:237,height:100},this.upgrades={shield:!1,dblFireRate:!1,dblSpeed:!1},this.score=0,this.kills=0,this.depth=consts.depths.player;let t=vars.getScene();this.preInit(t),this.init(t)}preInit(e){let t=e.input.keyboard;this.controls=t.createCursorKeys();let a=Phaser.Input.Keyboard;this.singlePlayer=1===vars.game.playerCount,this.singlePlayer&&(this.controls.keyW=t.addKey(a.KeyCodes.W),this.controls.keyS=t.addKey(a.KeyCodes.S),this.controls.keyA=t.addKey(a.KeyCodes.A),this.controls.keyD=t.addKey(a.KeyCodes.D)),this.initAnimations(e),this.cat=vars.physics.categories.player,this.bulletGroup=e.add.group()}init(e){this.initAudio(e),this.initPlayer(e),this.initParticles(e),this.initRockets(e)}initAnimations(e){for(let t in this.anims={damaged:{up:null,mid:null,down:null,shoot:null,death:null},undamaged:{shoot:"undamaged_shoot"}},this.anims.damaged){let a="death"===t?2:8,s="death"===t?[0,1,2,3]:[0,1],i="death"===t?0:-1,n=`damaged_${t}`;this.anims.damaged[t]=n,e.anims.create({key:n,frames:e.anims.generateFrameNames(this.type,{prefix:`${n}_`,frames:s}),frameRate:a,repeat:i})}["a","b","c"].forEach(t=>{e.anims.create({key:`rocket_${t}_anim`,frames:e.anims.generateFrameNames(this.type,{prefix:`rocket_${t}_`,frames:[0,1]}),frameRate:8})}),e.anims.create({key:"undamaged_shoot",frames:e.anims.generateFrameNames(this.type,{prefix:"shoot_",frames:[0,1]}),frameRate:8})}initAudio(e){this.audio={engine:e.sound.add("plane_engine",{loop:!0}),engine_space:e.sound.add("plane_engine_space",{loop:!0,volume:0}),shoot:e.sound.add("plane_shoot",{loop:!0}),ricochet:e.sound.add("ricochet",{loop:!1})}}initParticles(e){let t="smoke";this.onFireParticle=e.add.particles(t);let a=e.textures.get(t).getFrameNames();this.onFireParticle.createEmitter({frame:a,angle:{min:170,max:190},speed:{min:200,max:300},quantity:6,lifespan:2e3,alpha:{start:1,end:0},scale:{start:.5,end:.1},on:!1}),this.onFireParticle.setDepth(consts.depths.player+1)}initPlayer(e){let t=this.startPosition;this.object=e.matter.add.sprite(t.x,t.y,this.type,this.playerVars.defaultFrame).setDepth(this.depth),this.object.setBody({type:"rectangle",width:this.playerVars.width,height:this.playerVars.height}),this.object.setCollisionGroup(this.cat).setFriction(0,0),this.object.body.name=`player_${this.id}`,this.addHPBar(e),this.addSpeechBubble(e),this.addAtmosShield(),this.show(!1)}initRockets(e){let t=this.bulletGroup,a=this.object,s=a.displayWidth/2+5,i=vars.game.spaceSim,n=this.rockets={count:0,delay:1,delayMax:120,updateVars(){if(!i||!i.enabled||!a.alive||!n.count||(n.delay--,n.delay))return;n.delay=n.delayMax;let r=["a","b","c"];for(let o=0;o<n.count;o++){let l=r.shift(),h=e.add.sprite(a.x,a.y,"player",`rocket_${l}_1`);switch(h.play(`rocket_${l}_anim`),o){case 0:toX=a.x+s,toY=0;break;case 1:toX=0,toY=-50;break;case 2:toX=0,toY=50}h.x+=s,e.tweens.add({targets:h,alpha:1,x:a.x+toX,y:a.y+toY,duration:500,onComplete(){scene.matter.add.gameObject(bullet),bullet.setFriction(0,0).setSensor(!0).setVelocityX(8),t.add(bullet),e.tweens.addCounter({from:0,to:1,duration:500,onComplete(){let e=generateRandomID();e.name=`p1Bullet_${e}_r`,e.body.damage=15}})}})}}}}addSpeechBubble(e){let t=this.object,a=t.getTopRight(),s=this.bubbleContainer=e.add.container();s.setPosition(a.x,a.y).setDepth(this.depth+1);let i=e.add.image(0,0,"player","speech_bubble").setOrigin(0,1),n=i.getCenter(),r={...vars.fonts.small},o=this.bubbleMsg=e.add.text(n.x,n.y-7,"YP!",r).setOrigin(.5);s.add([i,o]),s.setAlpha(0),s.show=(t=!0)=>(s.tween=e.tweens.add({targets:s,alpha:t?1:0,duration:1e3,onComplete(){delete s.tween}}),1e3),s.updatePosition=()=>{s.alpha&&(a=t.getTopRight(),s.setPosition(a.x,a.y))},s.updateText=e=>{o.setText(e).setOrigin(.5)}}addAtmosShield(){let e=vars.getScene();this.atmosShield=e.add.image(this.object.x-10,this.object.y+5,"player","shield").setTint(27020).setAlpha(0).setDepth(this.depth-1),this.atmosShield.show=()=>{this.atmosShield.tween=e.tweens.add({targets:this.atmosShield,duration:33,repeat:20,alpha:1,yoyo:!0,onComplete:()=>{this.atmosShield.alpha=.25,this.atmosShield.tween=e.tweens.add({targets:this.atmosShield,alpha:1,duration:2e3,yoyo:!0,repeat:-1})}})}}addHPBar(e){let t=this.startPosition,a=this.hpBar=e.add.image(t.x,t.y-80,"gameObjects","hpBar").setAlpha(0).setDepth(this.depth),s=this.hpBarCounter=e.add.image(t.x-50,t.y-80,"pixelwhite").setScale(100,10).setOrigin(0,.5).setAlpha(0).setDepth(this.depth);s.setTint(this.getHPTint()),a.show=()=>{a.fadeOut&&(a.fadeOut.remove(),delete a.fadeOut),a.alpha=1,s.alpha=1,a.fadeOut=e.tweens.add({targets:[a,s],delay:5e3,duration:2e3,alpha:0,onComplete(){delete a.fadeOut}})}}attack(){let e=this.playerVars;e.shootDelay=e.shootDelayMax-e.shootDelayReduction,this.isShooting=!0;let t=this.audio.shoot;t.isPlaying||t.play(),this.createBullet()}bubbleChangeText(e=null){if(!e)return!1;this.bubbleContainer.updateText(e)}bubbleTextUpdateAndShow(e,t=1e3,a=2500){this.bubbleChangeText(e);let s=this.bubbleContainer,i=s.show();vars.getScene().tweens.addCounter({from:0,to:1,delay:i+t,duration:a,onComplete(){s.show(!1)}})}changeEngineSound(e="space"){let t="space"===e?{from:this.audio.engine,to:this.audio.engine_space}:{from:this.audio.engine_space,to:this.audio.engine},a=vars.getScene();t.to.play(),a.tweens.addCounter({from:0,to:1,duration:2e3,onUpdate(e,a){let s=a.value;t.from.volume=1-s,t.to.volume=s},onComplete(){t.from.pause()}})}checkForInput(){if(!vars.input.enabled)return;let e={left:["left"],right:["right"],up:["up"],down:["down"],shoot:["space"]};this.singlePlayer&&(e.left=[...e.left,"keyA"],e.right=[...e.right,"keyD"],e.up=[...e.up,"keyW"],e.down=[...e.down,"keyS"]),this.checkLeftRight(e),this.checkUpDown(e),this.checkShoot(e)}checkLeftRight(e){let t=this.controls,a=e.left,s=!1;a.forEach(e=>{!s&&t[e].isDown&&(s=!0)});let i=!1;(a=e.right).forEach(e=>{!i&&t[e].isDown&&(i=!0)}),s&&i||(s&&this.move("left"),i&&this.move("right"))}checkUpDown(e){let t=this.controls,a=e.up,s=!1;a.forEach(e=>{!s&&t[e].isDown&&(s=!0)});let i=!1;if((a=e.down).forEach(e=>{!i&&t[e].isDown&&(i=!0)}),!s&&!i||s&&i){let n=this.getFrameType();return this.anims[n].mid?this.object.play(this.anims[n].mid):this.object.anims.isPlaying||this.object.setFrame("default_mid"),!1}s&&this.move("up"),i&&this.move("down")}checkShoot(){if(this.playerVars.shootDelay)return!1;if(this.controls.space.isDown||this.singlePlayer&&vars.getScene().input.activePointer.isDown){this.attack();return}this.isShooting&&(this.isShooting=!1);let e=this.audio.shoot;e.isPlaying&&e.stop()}createBullet(){let e={x:this.object.x,y:this.object.y},t=this.playerVars.scale,a=`p${this.id}Bullet_${generateRandomID()}`,s=vars.getScene().matter.add.image(e.x+50,e.y-10,this.type,"bullet").setScale(t).setName(a).setDepth(consts.depths.bullets).setFriction(0,0).setCollisionCategory(this.cat);s.body.name=a,s.body.damage=1,s.setVelocityX(20),this.bulletGroup.add(s)}delaysUpdate(){this.playerVars.shootDelay&&this.playerVars.shootDelay--}destroyAllBullets(){this.bulletGroup.getChildren().forEach(e=>{e.destroy()})}destroyBulletByName(e){vars.game.player1.bulletGroup.getChildren().find(t=>t.body.name===e).destroy()}die(){if(this.alive){vars.DEBUG&&console.log("Player died"),this.alive=!1,this.playDeathSound(),this.audio.shoot.stop(),this.engineSplutter(),this.playDeathAnimation(),this.pushPlaneToDeath(),this.destroyAllBullets(),vars.game.enemyGroups.destroyAll(),vars.camera.shake();vars.game.level.isPaused=!0}}engineQuiet(e=!0){let t=this.audio.engine,a=e?[.3,0]:[0,.3];vars.getScene().tweens.addCounter({from:a[0],to:a[1],duration:2e3,onUpdate(e){t.volume=e.getValue()}})}engineSplutter(){let e=this.audio.engine,t=e.volume;vars.getScene().tweens.addCounter({from:-1,to:1,duration:250,yoyo:!0,repeat:4,onUpdate(a,s){e.volume=s.value<=0?0:t},onComplete(){e.stop(),e.volume=1}})}engineVolumeChange(e=!0,t=1e3){let a=e?[1,.3]:[.3,1],s=this.audio.engine;vars.getScene().tweens.addCounter({from:a[0],to:a[1],duration:t,onUpdate(e){s.volume=e.getValue()}})}getFrameType(){return this.playerVars.hp<=this.playerVars.hpMax/2?"damaged":"undamaged"}getHPTint(){let e=this.playerVars.hp;return e>=75?65280:e>=50?16744448:e>=25?16711680:8388608}hit(e=1){let t=this.playerVars;if(t.shield){this.audio.ricochet.play();return}let a=vars.camera;a.flash(100,128,0,0),a.shake(100),t.hp-=e,this.updateHPBarSize(),this.hpBar.show();let s=this.object;if(s.flashTween&&(s.flashTween.remove(),s.clearTint()),s.setTintFill(16777215),s.flashTween=vars.getScene().tweens.addCounter({from:0,to:1,duration:125,onComplete(){s.clearTint(),delete s.flashTween}}),t.hp<t.hpMax/2&&!t.onFire){t.onFire=!0,this.object.play(this.anims.damaged.mid);return}if(t.hp<=0){t.hp=0,this.die();return}}hpIncrease(e=1){let t=this.playerVars;t.hp+=e,t.hp>t.hpMax&&(t.hp=t.hpMax),t.hp>=t.hpMax/2&&this.object.anims.isPlaying&&(this.playerVars.onFire=!1,this.object.stop(),this.object.setFrame(this.playerVars.defaultFrame)),this.updateHPBarSize(),this.hpBar.show()}introduce(){let e=vars.getScene(),t=consts.canvas,a=vars.game;this.audio.engine.play(),this.engineVolumeChange(!0,3e3);let s=a[`player${this.id}`],i=this.object,n={x:i.x,y:i.y};i.setPosition(t.cX,t.cY),i.tween=e.tweens.add({targets:i,x:n.x,y:n.y,scale:.5,duration:3e3,onComplete(){delete i.tween,s.alive=!0,s.hpBar.show(),s.layer.container.show(),a.startEnemyWaves(),a.weather.cycle(),vars.input.enabled=!0,s.bubbleContainer.show(),e.tweens.addCounter({from:0,to:1,duration:3e3,onComplete(){s.bubbleContainer.show(!1)}})}});let r=vars.camera.game;r.zoom=2,r.tween=e.tweens.add({targets:r,zoom:1,duration:3e3,onComplete(){delete r.tween}})}isUpgraded(){let e=!1,t=this.upgrades;for(let a in t)t[a]&&!e&&(e=!0);return e}move(e){let t=this.playerVars,a="up"===e||"down"===e?t.speedY*t.speedMult:t.speedX*t.speedMult,s=this.getFrameType();switch(e){case"up":this.object.y-=a,this.anims[s][e]?this.object.play(this.anims[s][e]):this.object.setFrame(`default_${e}`);break;case"down":this.object.y+=a,this.anims[s][e]?this.object.play(this.anims[s][e]):this.object.setFrame(`default_${e}`)}switch(e){case"left":this.object.x-=a;break;case"right":this.object.x+=a}}moveAtmosShield(){this.atmosShield.alpha&&this.atmosShield.setPosition(this.object.x-10,this.object.y+5)}moveHPBar(){if(!this.hpBar.alpha)return;let e=this.object;this.hpBar.setPosition(e.x,e.y-80),this.hpBarCounter.setPosition(e.x-50,e.y-80)}moveLimit(){let e=consts.canvas,t=this.object,a=.8*e.width;t.y<130&&(t.y=130),t.y>e.height-60&&(t.y=e.height-60),t.x<70&&(t.x=70),t.x>a&&(t.x=a)}onFireParticleEmit(){if(!this.playerVars.onFire)return;let e=this.playerVars;if(e.smokeTimer--,e.smokeTimer)return!1;e.smokeTimer=getRandom(e.smokeTimerMin,e.smokeTimerMax),this.onFireParticle.emitParticleAt(this.object.x,this.object.y)}playDeathAnimation(){this.object.play(this.anims.damaged.death)}playDeathSound(){vars.audio.playSound("plane_explode")}pushPlaneToDeath(){let e=this.object;e.body.force={x:.01,y:.01},vars.getScene().tweens.addCounter({from:0,to:1,duration:3e3,onComplete(){vars.getScene().tweens.add({targets:e,alpha:0,duration:1e3,onComplete(){vars.physics.pause()}})}})}pushPlaneToPosition(e={x:100,y:100}){if(!e.x||!e.y){console.error(`Invalid push to position: x: ${e.x}, y: ${e.y}!`);return}this.isShooting=!1;let t=this.audio.shoot;t.isPlaying&&t.stop();let a=this.object,s,i=vars.game.getDistanceTo(a,e)/500*1e3,n=vars.getScene();return a.tweenMove=n.tweens.add({targets:a,x:e.x,y:e.y,duration:i,onComplete(){delete a.tweenMove}}),i}reset(){let e=this.playerVars;e.hp=e.hpMax,e.lives=3,e.onFire=!1,e.speedMult=1,e.shootDelayReduction=0,e.shield=!1,e.distanceTravelled=0,this.upgrades={shield:!1,dblFireRate:!1,dblSpeed:!1},this.score=0,this.kills=0,this.resetPosition(),this.layer.resetDistanceAndScore()}resetPosition(){this.object.setPosition(this.startPosition.x,this.startPosition.y)}scoreIncrease(e){this.score+=e,this.layer.setScore(this.score)}show(e=!0,t=0){let a=e?1:0;!a&&this.atmosShield.tween&&this.atmosShield.tween.pause();let s=this.object;if(!t){s.setAlpha(a),a||this.atmosShield.setAlpha(0);return}vars.getScene().tweens.add({targets:s,alpha:a,duration:t}),a||this.atmosShield.setAlpha(0)}update(){if(this.bubbleContainer.updatePosition(),!this.alive)return!1;this.delaysUpdate(),this.checkForInput(),this.moveLimit(),this.moveHPBar(),this.moveAtmosShield(),this.rockets.updateVars(),this.onFireParticleEmit(),this.updateDistanceTravelled(),this.updateBulletGroup()}updateBulletGroup(){this.bulletGroup.getChildren().forEach(e=>{e.x>1.1*consts.canvas.width&&e.destroy()})}updateDistanceTravelled(){let e=this.playerVars;e.distanceTravelled+=e.distanceInMetresEveryFrame,this.layer.setDistance(0|e.distanceTravelled)}updateHPBarSize(){this.hpBarCounter.setScale(this.playerVars.hp,10)}upgradeStart(e=!0){for(let t in this.upgrades)if(this.upgrades[t]){if(e)switch(vars.DEBUG&&console.log(`Starting Upgrade: ${t}`),t){case"dblFireRate":this.playerVars.shootDelayReduction=2;break;case"dblSpeed":this.playerVars.speedMult=1.5;break;case"shield":this.playerVars.shield=!0}else this.upgradeStop(t);break}}upgradeStop(e){switch(vars.DEBUG&&console.log(`Disabling Upgrade: ${e}`),e){case"dblFireRate":this.playerVars.shootDelayReduction=0;break;case"dblSpeed":this.playerVars.speedMult=1;break;case"shield":this.playerVars.shield=!1}this.upgrades[e]=!1}},SpaceSim=class{constructor(){this.enabled=!1,this.depth=consts.depths.alienUI,this.cC=consts.canvas,this.scene=vars.getScene(),this.fog=vars.game.level.layers[4],this.reality="normal",this.farTimeout=this.farTimeoutMax=3,this.bulletGroup=vars.game.enemyGroups.bulletGroup,this.init()}init(){let e=this.scene,t=this.cC,a=.85*t.width,s=t.cY,i=this.iSeeYouText=e.add.bitmapText(t.cX,s,"heading","I SEE YOU LITTLE HUMAN",72).setOrigin(.5).setTint(16711680).setDepth(this.depth).setAlpha(0),n=this.challengeText=e.add.bitmapText(t.cX,s,"heading","LETS SEE HOW YOU DEAL WITH AN ENEMY\nTHATS A LITTLE MORE ADVANCED THAN\nTHOSE SILLY LITTLE BIPLANES",56,1).setOrigin(.5).setTint(16711680).setDepth(this.depth).setAlpha(0),r=this.alienHead=e.add.image(a,s,"enemy","alien_head").setDepth(this.depth-1).setAlpha(0);i.show=()=>{let t=0;vars.game.getPlayers().forEach((e,a)=>{let s=e.pushPlaneToPosition({x:100,y:(a+1)*100+200});a||e.bubbleTextUpdateAndShow("???",s),s>t&&(t=s)}),i.tween=e.tweens.add({targets:i,alpha:1,delay:t,duration:1e3,hold:3e3,yoyo:!0,onComplete(){delete i.tween,r.show()}})},r.show=(a=!0)=>{r.tween&&(r.tween.remove(),delete r.tween),e.tweens.add({targets:r,alpha:a?.2:0,duration:500,onComplete(){a&&(n.show(),r.tween=e.tweens.add({targets:r,x:.45*t.width,alpha:.8,duration:2e3,ease:"Quad.easeInOut",yoyo:!0,repeat:-1}))}})},n.show=()=>{e.tweens.addCounter({from:0,to:1,duration:2e3,onComplete(){vars.game.player1.bubbleTextUpdateAndShow("Pfft...\nMon en.")}}),n.tween=e.tweens.add({targets:n,alpha:1,duration:1e3,hold:5e3,yoyo:!0,onComplete(){delete n.tween,r.show(!1),vars.game.spaceSim.introduce()}})},this.starsDepth=consts.depths.stars,this.starsContainer=e.add.container().setDepth(this.starsDepth).setAlpha(0),this.initStars(),this.initParallaxLayers()}initStars(){let e=this.starsContainer,t=this.cC,a=this.scene;this.squareOfDOOM=new Phaser.Geom.Rectangle(-50,-50,t.width+100,t.height+100);let s=this.bg=a.add.image(t.cX,t.cY,"pixel1").setScale(t.width,t.height);e.add(s);let i=this.starParticles=a.add.particles("particles");e.add(i),this.starParticles.emitter=this.starParticles.createEmitter({x:t.width+10,y:{min:2,max:t.height-2},speedX:{min:-133,max:-533},scaleX:{min:.01,max:.1},scaleY:.01,lifespan:1e4,blendMode:"ADD",quantity:1,frequency:10,deathZone:{type:"onLeave",source:this.squareOfDOOM}}),this.warmStars()}initParallaxLayers(){let e=this.scene,t=this.cC;this.layers=[{name:"background",frame:"tech_bg",origin:{x:0,y:.5},x:0,y:t.cY,deltaX:0,flipX:!1,flipY:!1,container:null,containerStartX:0,depth:this.starsDepth+1},{name:"upper",frame:"tech_upper",origin:{x:0,y:0},x:0,y:0,deltaX:40,deltaXReal:3,deltaXMod:.1,flipX:!1,flipY:!1,container:null,containerStartX:t.width+t.cX,depth:this.starsDepth+3},{name:"lower",frame:"tech_upper",origin:{x:0,y:1},x:-t.cX,y:t.height,deltaX:40,deltaXReal:3,deltaXMod:.1,flipX:!0,flipY:!0,container:null,containerStartX:t.width,depth:this.starsDepth+3}];let a=t.width/1920,s=this.shieldBlend=e.add.image(t.cX,t.cY,"pixelwhite").setScale(t.width,t.height/5).setBlendMode(2).setDepth(this.starsDepth+2).setTint(65280).setAlpha(0);s.updateAlpha=()=>{s.y=vars.game.player1.object.y},this.layers.forEach(i=>{let n=e.add.container().setDepth(i.depth).setAlpha(0);"background"===i.name&&(n.show=()=>{n.tween=e.tweens.add({targets:n,alpha:.1,duration:2500,onComplete(){delete n.tween,n.tween=e.tweens.add({targets:n,alpha:.15,duration:5e3,yoyo:!0,repeat:-1,ease:"Quint.easeInOut"})}}),s.tween=e.tweens.add({targets:s,alpha:.2,duration:5e3,onComplete(){delete s.tween;let e=vars.game.enemyGenerator;e.setNextSpawnPosition(),e.levelChanging=!1}})}),n.deltaX=i.deltaX,i.container=n,n.scrollUpdate=e=>{n.x-=e,n.x<-t.width&&(n.x+=t.width)};for(let r=0;r<2;r++){let o=r*t.width,l=i.y,h=e.add.image(o,l,"backgrounds",i.frame).setScale(a).setOrigin(i.origin.x,i.origin.y).setFlipX(i.flipX).setFlipY(i.flipY);n.add(h)}i.containerStartX&&(n.x+=i.containerStartX)})}addBossFireContainer(e){if(this.fireContainer)return this.fireContainer;let t=this.cC,a=this.scene,s=this.bossFireContainer=a.add.container().setDepth(e).setAlpha(0),i=this.bossFireLayers=[],n=a.add.image(0,0,"enemy","boss_m0").setOrigin(0).setAlpha(0);s.width=n.width,s.height=n.height;let r=t.width-240+s.width/2;s.startX=r,s.x=r,a.matter.add.gameObject(s),i.push(n);let o=s.body,l=generateRandomID();o.name=`eBullet_boss_mouth_${l}`,o.damage=1,s.setFriction(0,0).setSensor(!0),s.finalX=-s.width/2;let h=n.getCenter();[1,2,3].forEach(e=>{let t=a.add.image(h.x+80,h.y,"enemy",`boss_m${e}`).setAlpha(0);i.push(t)});let d=n.width/2,p=n.height/2;return i.forEach(e=>{e.setPosition(e.x-d,e.y-p)}),s.add(i),i.reverse(),s.show=e=>{s.y=e,s.x=s.startX,s.alpha=1,i.forEach((e,t)=>{e.tween=a.tweens.add({targets:e,alpha:1,duration:250,delay:250*t,onComplete(){delete e.tween,t===i.length-1&&(s.tween=a.tweens.add({targets:s,x:s.finalX,duration:2e3,onComplete(){delete s.tween,s.alpha=0,s.x=s.startX,i.forEach(e=>{e.alpha=0})}}))}})})},s.setOnCollideActive(e=>{if(!e.bodyA.name||!e.bodyB.name)return!1;if(!e.bodyA.name.startsWith("player_"))return;let t=0|e.bodyA.name.replace("player_",""),a=vars.game[`player${t}`],s=e.bodyB.damage;a.hit(s)}),s}breakReality(){this.enabled=!0,vars.game.weather.stopEverything(),this.reality="FUKD"}generateBoss(){let e=this.scene,t=this.cC,a=consts.depths.enemies,s=e.cache.json.get("alien_boss-shape"),i=`enemy_boss_${generateRandomID()}`,n=this.boss=e.matter.add.image(t.width,t.cY,"enemy","alien_boss",{shape:s}).setName(i).setDepth(a),r=vars.game.enemyGroups;r.alienGroup.add(n),r.alienGroups.push(n);let o=n.body;o.alive=!1,o.hp=666,o.hpMax=o.hp,o.name=i;let l=n.displayWidth;n.x+=l/2+50,n.defaultX=n.x-l;let h=n.displayHeight,d=n.y-h/2;n.y=d;let p=n.y+.75*h,c=this.addBossFireContainer(a-1);e.anims.get("explode_boss")||e.anims.create({key:"explode_boss",frames:e.anims.generateFrameNumbers("explosion_boss",{start:0,end:24}),frameRate:24}),n.shootVars={weapons:["eye"],currentWeapon:"mouth",shootTimeOut:60,shootTimeOutMax:240,canShoot:!1,minY:d,maxY:p};let u=n.shootVars;n.updateVars=()=>{if(n.body.alive&&!n.tweens.updown.paused){if(!u.canShoot){if(u.shootTimeOut--,u.shootTimeOut)return;u.canShoot=!0}n.canShoot()}},n.canShoot=()=>{let e=vars.game.player1.object.y;n.y>e-50&&n.y<e+50&&n.shoot()},n.breatheFire=()=>{vars.audio.playSound("breathe_fire"),c.show(n.y+110)},n.hit=a=>{let s=this.boss;if(s.body.hp-=a,this.updateBossHPBar(),s.flashTween&&(s.flashTween.remove(),s.clearTint()),s.setTintFill(16777215),s.flashTween=this.scene.tweens.addCounter({from:0,to:1,useFrames:!0,duration:1,onComplete(){s.clearTint(),delete s.flashTween}}),s.body.hp<=0){this.containerHP.fadeOut(),s.body.alive=!1,s.tweens.updown.remove(),delete s.tweens.updown;let i=Phaser.Math.Clamp,n=s.x-s.width/2,o=t.width,l=i(s.y-s.height/2,0,t.height),h=i(s.y+s.height/2,0,t.height),d=s.depth+1;for(let p=0;p<50;p++){let c=100*p;e.tweens.addCounter({from:0,to:1,duration:c,onComplete(){let t=getRandom(n,o),a=getRandom(l,h);(p%10==5||p%10==0)&&vars.audio.playSound("plane_explode");e.add.sprite(t,a,"explosion_boss").setDepth(d).play("explode_boss"),38===p&&e.tweens.add({targets:s,alpha:0,duration:1e3,onComplete(){console.log("%cCLEANUP: SpaceSim: Destroyed boss, removed from alien groups","color: #f4a333"),s.destroy(),r.alienGroups=[],vars.game.win()}})}})}}},n.shoot=()=>{u.canShoot=!1;let t=u.currentWeapon,a=vars.game.enemyGroups.bulletGroup,s=consts.depths.bullets;switch(u.weapons.push(t),u.currentWeapon=u.weapons.shift(),n.tweens.updown.pause(),t){case"eye":vars.audio.playSound("eye_show");let i=n.body.hp<=n.body.hpMax/2?5:3,r=n.x-(3===i?60:90)-n.width/1.5,o=n.y-12,l=e.cache.json.get("alien_boss_eye-shape");for(let h=0;h<i;h++){let d=h?h<3?30:60:0,p=h?h<3?30:70:0,c=r+d,$=h&&h%2==0?o+p:o-p,g=10*getRandom(1,36),m=e.add.image(c,$,"enemy","boss_eye").setDepth(s+6).setScale(.01).setAngle(g);m.tween=e.tweens.add({targets:m,scale:.5,duration:1e3,onComplete(){delete m.tween,e.matter.add.gameObject(m,{shape:l});let t=generateRandomID();m.body.name=`eBullet_boss_eye_${t}`,m.body.damage=20,m.setFriction(0,0).setSensor(!0).setAngularVelocity(-.2),m.setVelocityX(-15),h===i-1&&(vars.audio.playSound("eye_accelerate"),u.shootTimeOut=u.shootTimeOutMax,n.tweens.updown.resume())}}),a.add(m)}case"mouth":n.tweens.mouthAttack=e.tweens.add({targets:n,x:n.x+260,y:n.y-170,duration:500,ease:"Quad.easeInOut",onComplete(){n.tweens.mouthAttack=e.tweens.add({targets:n,angle:45,duration:250,ease:"Quad.easeInOut",onComplete(){n.breatheFire(),n.tweens.mouthAttack=e.tweens.add({targets:n,delay:3e3,angle:0,duration:250,ease:"Quad.easeOut",onComplete(){n.tweens.mouthAttack=e.tweens.add({targets:n,x:n.x-260,y:n.y+170,duration:500,ease:"Quad.easeOut",onComplete(){delete n.tweens.mouthAttack,n.tweens.updown&&(u.shootTimeOut=u.shootTimeOutMax,n.tweens.updown.resume())}})}})}})}});default:console.error(`Unknown current weapon ${u.currentWeapon}`)}},n.tweens={},n.tweens.updown=e.tweens.add({targets:n,y:p,duration:3e3,ease:"Quad.easeInOut",yoyo:!0,repeat:-1});let $=n.defaultX;n.tweens.intro=e.tweens.add({targets:n,x:$,duration:2e3,ease:"Quad.easeOut",onComplete(){delete n.tweens.intro,n.body.alive=!0,vars.game.enemyGenerator.setNextSpawnPosition()}}),this.generateBossHPBar()}generateBossHPBar(){let e=this.cC,t=this.scene,a=this.containerHP=t.add.container().setDepth(this.depth);a.fadeOut=()=>{t.tweens.add({targets:a,alpha:0,duration:2e3,onComplete(){a.destroy(),console.log("%cCLEANUP: SpaceSim: Destroyed the boss hp bar","color: #f4a333")}})};let s=this.bossHPBar=t.add.image(e.cX,e.height,"gameObjects","bossHPBG");s.y-=s.height/2+10;let i=this.bossHPBar.getTopLeft(),n=this.hpBar=t.add.image(i.x+3,i.y+3,"pixelwhite").setTint(11665408).setOrigin(0);this.hpBar.maxWidth=s.width-6;let r=s.height-6;n.setScale(this.hpBar.maxWidth,r);let o=vars.fonts.large,l=t.add.text(s.x,s.y,"GALDRAGONS WITNESS: EATER OF WORLDS",o,1).setOrigin(.5);a.add([s,n,l])}generateFoos(){let e=this.scene,t=this.cC,a={x:t.cX,y:t.cY},s=vars.game,i=s.getPlayers(),n=i.length>1?{x:-50,y:-50}:{x:0,y:0},r=0;vars.input.enabled=!1,i.forEach((e,t)=>{let s=e.pushPlaneToPosition({x:a.x+n.x,y:a.y+n.y});s>r&&(r=s),t||e.bubbleTextUpdateAndShow("Wait...\nWhat are those?",s),n.x*=-1,n.y*=-1});let o=consts.depths.enemies+1,l=this.fooContainers=[];[120,240,480,600].forEach((a,i)=>{let n=e.add.container().setDepth(o);l.push(n);let h=e.add.image(0,0,"enemy","foo_glow");h.tween=e.tweens.add({targets:h,alpha:.9,duration:125,yoyo:!0,repeat:-1});let d=h.getCenter(),p=e.add.image(d.x,d.y,"enemy","foo_body");n.add([p,h]),n.width=h.width,n.height=h.height,n.setPosition(0,a);let c=.65*t.width;e.tweens.add({targets:n,x:c-100*i,delay:r+250*(i+1),duration:1e3,hold:3e3,onComplete:()=>{3===i&&e.tweens.add({targets:l,x:t.cX,duration:500,hold:2e3,onComplete:()=>{e.tweens.add({targets:l,x:t.width+100,duration:500,onComplete:()=>{this.fooContainers.forEach(e=>{e.getAll().forEach(e=>{e.tween&&e.tween.remove()}),e.destroy()}),delete this.fooContainers,s.spaceSim.show()}})}})}})})}hideParallaxLayers(e=2e3){let t=this.scene,a=[];return this.layers.forEach(e=>{a.push(e.container),e.container.tween&&(e.container.tween.remove(),delete e.container.tween)}),this.shieldBlend.alpha=0,t.tweens.add({targets:a,alpha:0,delay:67,duration:e}),e+67}introduce(){let e=vars.game,t=vars.camera.game,a=this.scene;this.breakReality(),this.starParticles.emitter.resume();let s=this.starsContainer,i=this.fog,n=this.depth,r=vars.audio.playSound;r("static"),a.tweens.addCounter({from:0,to:1,duration:500,hold:250,yoyo:!0,repeat:1,onUpdate(e,t){t.value<=.5?(s.alpha=0,i.alpha=1):(s.alpha=1,i.alpha=0)},onYoyo(){t.flash(100),r("static")},onRepeat(){t.flash(100),r("static")},onComplete(){a.tweens.addCounter({from:0,to:1,duration:125,yoyo:!0,repeat:3,onUpdate(e,t){t.value<=.5?(s.alpha=0,i.alpha=1):(s.alpha=1,i.alpha=0)},onYoyo(){t.flash(66),r("static")},onComplete(){i.alpha=0,e.level.hideWar(),t.flash(5e3),a.tweens.add({targets:s,alpha:1,duration:5e3,onComplete(){let t=`I HAVE UPGRADED YOUR LITTLE PLANE

Upgrades:
Speed Up
Bullet Speed Up
Atmos-Shield`;e.getPlayers().forEach(e=>{e.playerVars={...e.playerVars,speedX:8,speedY:8,shootDelayMax:4},e.atmosShield.show(),e.changeEngineSound("space")}),vars.audio.switchTrackType("spaceGameplay");let s=consts.canvas,i=e.spaceSim;i.upgradeText=a.add.bitmapText(s.cX,s.cY,"heading",t,56,1).setOrigin(.5).setTint(16711680).setDepth(n).setAlpha(0),i.upgradeText.introTween=a.tweens.add({targets:i.upgradeText,alpha:1,duration:500,hold:5e3,yoyo:!0,onComplete(){vars.input.enabled=!0,i.upgradeText.destroy(),delete i.upgradeText,e.level.spaceSim=!0;let t=e.enemyGenerator;t.levelChanging=!1;let a=e.player1.playerVars,s=t.levels[t.currentLevel];s.nextSpawnDistance=a.distanceTravelled+s.distanceBetweenGroupsInMetres}})}})}})}})}introduceBoss(){["upper","lower"].forEach(e=>{let t=this.layers.find(t=>t.name===e).container;t.deltaXReal=0,t.deltaXMod=.1}),this.generateBoss()}show(){this.showAlienGod()}showAlienGod(){this.iSeeYouText.show()}showParallaxLayer(e){let t=this.layers.find(t=>t.name===e);if(t){t.container.show?t.container.show():t.container.setAlpha(1);return}return console.error(`Container named ${e} was NOT found!`),!1}update(){this.layers.forEach(e=>{if(e.container.alpha&&e.deltaX&&(e.container.scrollUpdate(e.deltaX),e.deltaXReal&&e.deltaX>e.deltaXReal&&(e.deltaX-=e.deltaXMod),e.deltaXReal&&e.deltaX<=e.deltaXReal)){e.deltaX=e.deltaXReal,delete e.deltaXReal;let t=vars.game.enemyGenerator;t.setNextSpawnPosition(),t.levelChanging=!1}}),this.shieldBlend.alpha&&this.shieldBlend.updateAlpha(),this.boss&&this.boss.body.alive&&this.updateBoss()}updateBoss(){this.boss.updateVars()}updateBossHPBar(){let e=this.boss,t=e.body.hp,a=e.body.hpMax;this.hpBar.setScale(this.hpBar.maxWidth*(t/a),this.hpBar.displayHeight)}warmStars(){let e=this.starsContainer;e.setVisible(!1),this.scene.tweens.addCounter({from:0,to:1,duration:1e4,onComplete:()=>{this.starParticles.emitter.pause(),e.setVisible(!0)}})}},UILayer=class{constructor(e){let t=vars.getScene();switch(e){case"playerIntroText":this.introText();break;case"player1":this.initPUI(t,1);break;case"player2":this.initPUI(t,2);break;case"gameComplete":this.initGameComplete();break;case"debug":this.initDebug(t);break;default:return console.error(`Unknown UI Layer "${e}"`),!1}this.which=e}initDebug(e){let t=consts.canvas,a=e,s=this.container=a.add.container().setDepth(999),i={...vars.fonts.small,align:"left",strokeThickness:0,fontSize:"12px"},n=t.width,r=t.cY,o=a.add.image(n,r,"pixelblack").setScale(300,t.cY).setOrigin(1,0).setAlpha(.2),l=this.debugText=a.add.text(t.width-300+10,r+10,"Player 1",i).setOrigin(0,0);this.weatherText=a.add.text(t.width-300+10,r+10,"Weather:",i).setOrigin(0,0),this.weatherArray=[],s.add([o,l])}initGameComplete(){let e=consts.canvas,t=consts.depths.gameUI,a=vars.getScene(),s=this.container=a.add.container().setDepth(t).setAlpha(0),i=a.add.image(e.cX,e.cY,"pixelblack").setScale(e.width,e.height),n=a.add.bitmapText(e.cX,e.cY/2,"default","Well done.\n\nYou completed the game.",42,1).setOrigin(.5),r=.45*e.height,o=this.killsScoreP1=a.add.bitmapText(e.cX,r,"default","Player 1 - Kills: 0. Score: 0",42,1).setOrigin(.5).setAlpha(0),l=this.killsScoreP2=a.add.bitmapText(e.cX,r+50,"default","Player 2 - Kills: 0. Score: 0",42,1).setOrigin(.5).setAlpha(0);r=.8*e.height;let h=this.restartButton=a.add.image(e.cX,r,"pixelwhite").setScale(200,60).setTint(2162464).setAlpha(0).setInteractive();h.on("pointerdown",()=>{if(h.alpha<1)return;h.alpha=.99,console.log("Restarting the game");let e=vars.game;e.startEnemyWaves(),e.level.restart(),[1,2].forEach(t=>{let a=e[`player${t}`];a&&(a.reset(),a.engineQuiet(!1),a.alive=!0)}),s.show(!1)});let d=a.add.bitmapText(e.cX,r,"default","Restart.",32,1).setTint(32768).setDropShadow(2,2,0,.9).setOrigin(.5).setAlpha(0);s.add([i,n,o,l,h,d]),s.show=(e=!0)=>{let t=e?1:0;s.showTween=a.tweens.add({targets:s,alpha:t,duration:t?2e3:500,onComplete(){if(t){a.tweens.add({targets:[h,d],alpha:1,duration:1250,delay:750});return}h.alpha=0,d.alpha=0}})}}initPUI(e,t){let a=e,s=this.playerID=t,i=consts.canvas,n=consts.depths.gameUI,r=1===s?2140704:8454016,o=this.container=a.add.container().setDepth(n).setAlpha(0);o.show=(e=!0)=>{o.tween=a.tweens.add({targets:o,duration:750,alpha:e?1:0,onComplete(){delete o.tween}})};let l=i.width-10,h=1===s?10:i.cY/3;this.score=a.add.bitmapText(l,h,"heading",`P${s} Score: 0`,24).setOrigin(1,0).setTint(r);let d=this.score.displayHeight;h+=d+10,this.confirmedKills=a.add.bitmapText(l,h,"heading",`P${s} Kills: 0`,24).setOrigin(1,0).setTint(r),h+=d+10,this.distance=a.add.bitmapText(l,h,"heading","Distance: 0km",24).setOrigin(1,0).setTint(r),o.add([this.score,this.confirmedKills,this.distance])}introText(){let e=consts.canvas,t=vars.getScene(),a=consts.depths.playerIntroText,s=this.container=t.add.container().setDepth(a),i=`May 12th 1913

\
        You are Wee Jimmy the Thieving Bawbag III.
\
        Well known in parts of Scotland for being able to nick your gold
\
        teeth out your mouth, just by looking at you, from across the street.
\
        One of the few people to have successfully sold both their
\
        grandmothers (even though one of them were already dead) and is
\
        actively taking bids on his only remaining grandfather
\
        This time, however, youve outdone yourself.
\
        Youve only gone and nicked the Red Barons bi-plane.
\
        Now you have to fight your way back to Scotland, preferably landing
\
        somewhere near the chippy, just down the road from your house.
\
        As you hurl youself into the air, you look back and see the entire
\
        german air force coming after you.
\
        You look at them...
\
        Laugh...
\
        And hail them with your battle cry...

\
        YP!`,n=e.cX,r=e.height,o=t.add.bitmapText(n,r,"heading",i,48,0).setOrigin(.5,0).setTint(16744448).setDropShadow(2,2,0,.9),l=0-o.height,h=this.bg=t.add.image(e.cX,e.cY,"gameObjects","intro_bg");s.add([h,o]);vars.audio.playTrack(),s.update=()=>{let e=t.input.activePointer.isDown?7:1;if(o.y>l){o.y-=1*e;return}s.destroy(),delete this.container,vars.audio.switchTrackType("earthGameplay"),vars.game.level.start()}}addToWeatherArray(e){let t=this.weatherArray;t.push(e),t.length>4&&t.splice(0,t.length-4)}resetDistanceAndScore(){this.setDistance(0),this.setScore(0)}setDistance(e){this.distance.setText(`Distance: ${e/1e3}Km`)}setScore(e){this.score.setText(`P${this.playerID} Score: ${e}`)}updateDebug(){let e="";[1,2].forEach(t=>{let a=vars.game[`player${t}`];if(a){let s=a.playerVars;for(let i in e+=`Player ${t}:`,e+=`
  shooting: ${a.isShooting}`,e+=`
  hp: ${s.hp}`,e+=`
  onFire: ${s.onFire}`,e+=`
  shield: ${s.shield}`,e+=`
Upgrades:`,a.upgrades)e+=`
  ${i}: ${a.upgrades[i]?"enabled":"disabled"}`}});let t=vars.game.weather,a=t.weather,s="\nWeather:";for(let i in a)s+=`
  ${i}: ${a[i]}`;s+="\n";let n=this.weatherArray.join("\n").trim();t.weatherChangeTween&&(n+=`
  Delay: ${((t.weatherChangeTween.totalDuration-t.weatherChangeTween.elapsed)/1e3).toFixed(2)}s`),n=s+n,this.debugText.setText(e+n)}updateGameOverScreen(){let e=vars.game;["player1","player2"].forEach(t=>{let a=t.replace("player","");if(e[t]){let s=e[t];this[`killsScoreP${a}`].setText(`Player ${a} - Kills: ${s.kills}. Score: ${s.score}`),this[`killsScoreP${a}`].setAlpha(1)}else this[`killsScoreP${a}`].setAlpha(0)})}},WeatherSystem=class{constructor(e){this.scene=vars.getScene(),this.currentDepthIndex=0,this.depths=[...vars.game.level.layerDepths],this.depths.forEach((e,t)=>{this.depths[t]=e+1}),this.initRain(),this.initFog(),this.weather={raining:0,foggy:1},this.weatherChangeTween=null}initFog(){this.fog=vars.game.level.layers[4]}initRain(){let e=consts.canvas,t=this.scene,a=this.rainParticles=t.add.particles("particles");a.setDepth(this.depths[this.currentDepthIndex]),this.rainParticles.emitterLight=a.createEmitter({frame:"white",y:-64,x:{min:0,max:e.width-3},lifespan:3e3,speedY:{min:300,max:700},scaleX:.05,scaleY:.15,quantity:1}),this.rainParticles.emitterHeavy=a.createEmitter({frame:"white",y:-64,x:{min:0,max:e.width-3},lifespan:3e3,speedY:{min:300,max:700},scaleX:.07,scaleY:.15,quantity:2}),t.tweens.addCounter({from:0,to:1,duration:1e3,onComplete(){vars.game.weather.rainStop()}});let s=this.rainHeavyMask=t.add.image(e.cX,e.cY,"pixelblack").setScale(e.width,e.height).setDepth(consts.depths.nightMask).setAlpha(0);s.fadeIn=(e=!0)=>{s.tween=t.tweens.add({targets:s,alpha:e?.3:0,duration:3e3})}}fogFadeIn(e=!0,t=1,a=1e4){let s=this.scene,i=this.fog;return i.tweenAlpha=s.tweens.add({targets:i,alpha:e?t:.15,duration:a,onComplete(){delete i.tweenAlpha}}),a}cycle(){if(vars.game.level.isPaused||this.allStop)return;console.log("%cNew Cycle","color: #2020ff");let e=vars.UI.debug;e&&e.addToWeatherArray("New Cycle");let t="";this.weatherChangeTween=null;let a=this.scene;if(this.weather.raining){console.log(`%c >> Its currently raining (${1===this.weather.raining?"lightly":"heavily"})`,"color: #20ff20");let s=getRandom(["stop",1,2]),i=getRandom(0,1);if(console.log(`%c >> Changing weather (${i?"now":"after a delay"})`,`color: ${i?"#20ff20":"#ff8000"}`),i){if(t+="Immediate weather change ","stop"!==s){if(this.weather.raining!==s){console.log(`%c >> The rain type is changing from ${1===this.weather.raining?"light":"heavy"} to (${1===s?"light":"heavy"})`,"color: #20ff20");let n=1===s?"Heavy":"Light",r=1===s?"Light":"Heavy";t+=` from ${n} to ${r}`,e&&e.addToWeatherArray(t),this.stopEmitter(n),this.rainStart(r)}return}this.rainStop();let o=1e3*getRandom(15,45);t+=` - STOP
Next cycle in ${o/1e3}s`,e&&e.addToWeatherArray(t),console.log(`%c  >> Next weather cycle in ${o/1e3}s`,"color: #20ff20"),a.tweens.addCounter({from:0,to:1,duration:o,onComplete(){vars.game.weather.cycle()}});return}let l=1e3*getRandom(15,40);t+=`Delaying rain change by ${l/1e3}s`,e&&e.addToWeatherArray(t),console.log(`%c   >> Delaying Rain Change by ${l/1e3}s`,"color: #20ff20"),this.weatherChangeTween=a.tweens.addCounter({from:0,to:1,duration:l,onComplete:()=>{let t="Delayed rain change ";if("stop"!==s){if(this.weather.raining!==s){vars.game.weather.rainStart(1===s?"light":"heavy");return}t+="- No Change",e&&e.addToWeatherArray(t);return}vars.game.weather.rainStop();let i=1e3*getRandom(15,45);t+=` - STOP
Next cycle: ${i/1e3}s`,e&&e.addToWeatherArray(t),console.log(`%c  >> Next weather cycle in ${i/1e3}s`,"color: #20ff20"),a.tweens.addCounter({from:0,to:1,duration:i,onComplete(){vars.game.weather.cycle()}})}});return}if(!getRandom(0,1)){let h=1e3*getRandom(30,60);t+=`No rain today.
Next cycle: ${h/1e3}s`,e&&e.addToWeatherArray(t),console.log(`%cNext weather cycle in ${h/1e3}s`,"color: #20ff20"),this.weatherChangeTween=a.tweens.addCounter({from:0,to:1,duration:h,onComplete(){vars.game.weather.cycle()}});return}if(!getRandom(0,1)){let d=1e3*getRandom(15,40);t+=`Delayed rain!
Starting in ${d/1e3}s`,e&&e.addToWeatherArray(t),console.log(`%c  >> Delaying Light Rain by ${d/1e3}s`,"color: #20ff20"),this.weatherChangeTween=a.tweens.addCounter({from:0,to:1,duration:d,onComplete:()=>{this.rainStart("light")}});return}t+="Starting the rain now!",e&&e.addToWeatherArray(t),this.rainStart("light")}rainStart(e="light"){if(this.allStop)return;console.log(`%c  >> Starting ${e} rain`,"color: #20ff20");let t=vars.UI.debug,a=`Rain Start: ${e}`;t&&t.addToWeatherArray(a),this.weatherChangeTween=null;let s=vars.getScene(),i=this.rainParticles;if("light"===(e=e.toLowerCase())){let n=this.depths[0];2===this.weather.raining&&(n=this.depths[this.depths.length-1],this.stopEmitter("Heavy"));let r=i.emitterLight;if(this.startEmitter(r),this.weather.raining=1,n){i.setDepth(n);let o=1e3*getRandom(15,25);console.log(`%cNext weather cycle in ${o/1e3}s`,"color: #20ff20"),s.tweens.addCounter({from:0,to:1,duration:o,onComplete(){vars.game.weather.cycle()}});return}this.tweenDepth=s.tweens.addCounter({from:0,to:this.depths[this.depths.length-1],duration:1e4,onUpdate(e,t){i.setDepth(t.value+.5|0),console.log(`  --- depth: ${t.value+.5|0}`)},onComplete(){let e=1e3*getRandom(10,30);console.log(`%cNext weather cycle in ${e/1e3}s`,"color: #20ff20"),s.tweens.addCounter({from:0,to:1,duration:e,onComplete(){vars.game.weather.cycle()}})}});return}let l=this.weather.raining?this.depths[this.depths.length-1]:this.depths[0];1===this.weather.raining&&this.stopEmitter("Light"),this.weather.raining=2;let h=this.rainParticles.emitterHeavy;i.setDepth(l),this.startEmitter(h);let d=1e3*getRandom(30,50);console.log(`%cNext weather cycle in ${d/1e3}s`,"color: #20ff20"),s.tweens.addCounter({from:0,to:1,duration:d,onComplete(){vars.game.weather.cycle()}})}rainStop(){console.log(" >> %cStopping the rain","color: #ff2020"),["Light","Heavy"].forEach(e=>{this.stopEmitter(e)}),this.rainHeavyMask.setAlpha(0),this.rainParticles.setDepth(this.depths[0]),this.weather.raining=!1}startEmitter(e){console.log("  >> %cStarting Emitter","colour: #2020ff"),e.setAlpha(1),e.resume(),this.rainParticles.setDepth(this.depths[0])}stopEmitter(e){console.log(`  >> %cStopping emitter ${e}`,"color: #ff2020");let t=this.rainParticles[`emitter${e}`];t.alpha.propertyValue&&this.scene.tweens.addCounter({from:1,to:0,duration:5e3,onUpdate(e,a){t.setAlpha(a.value)},onComplete(){t.pause()}})}stopEverything(){this.allStop=!0,this.weather={raining:!1,foggy:0},this.rainStop()}};